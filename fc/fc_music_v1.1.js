var e;!function(e){e.LOOP='loop',e.SINGLE='single',e.SHUFFLE='shuffle'}(e||(e={}));let t=null,n=[],o=-1,r=!1,a='gufeng',s=e.LOOP;const i='fc_music_player_state';let c=0;function l(){if(!t){t=new Audio,t.volume=.7,t.addEventListener('ended',()=>{!function(){switch(s){case e.SINGLE:o>=0&&h(o);break;case e.SHUFFLE:if(n.length>1){let e;do{e=Math.floor(Math.random()*n.length)}while(e===o&&n.length>1);h(e)}else v();break;case e.LOOP:default:v()}}()}),t.addEventListener('play',()=>{r=!0,c=Date.now(),u()}),t.addEventListener('pause',()=>{r=!1,u()}),t.addEventListener('loadedmetadata',()=>{t&&u()});let a=0;t.addEventListener('timeupdate',()=>{if(t){const e=Date.now();e-a>=1e3&&(u(),a=e)}})}}function u(){if(!t)return;const e={isPlaying:r,currentTime:t.currentTime||0,duration:t.duration||180,playMode:s,timestamp:Date.now()};try{const t=localStorage.getItem(i);if(t){const n={...JSON.parse(t),...e};localStorage.setItem(i,JSON.stringify(n))}}catch(e){console.warn('ä¿å­˜æ’­æ”¾çŠ¶æ€å¤±è´¥:',e)}}function g(){try{const e=localStorage.getItem('fate_console_ui_state');if(e){return JSON.parse(e).theme||'gufeng'}}catch(e){console.warn('è¯»å–ä¸»é¢˜å¤±è´¥:',e)}return'gufeng'}async function f(){try{a=g(),console.log('å½“å‰ä¸»é¢˜:',a);const e=await getWorldbook('å‘½è¿ç»ˆç«¯');if(!e)return void toastr.error('æœªæ‰¾åˆ°"å‘½è¿ç»ˆç«¯"ä¸–ç•Œä¹¦','éŸ³ä¹æ’­æ”¾å™¨');const t=e.find(e=>'éŸ³ä¹'===e.name);if(!t||!t.content)return void toastr.error('ä¸–ç•Œä¹¦ä¸­æœªæ‰¾åˆ°éŸ³ä¹æ¡ç›®','éŸ³ä¹æ’­æ”¾å™¨');const o=t.content.split('\n').map(e=>e.trim()).filter(e=>e);n=[];const r={å¤é£:'gufeng',ä»™ä¾ :'xianxia',æ°‘ä¿—:'minsu',æ­¦ä¾ :'wuxia',ç„å¹»:'xuanhuan',æ—¥å¼:'nihon'};let s='';for(const e of o)if(e.endsWith('ï¼š')){const t=e.slice(0,-1);s=r[t]||t}else if(s===a&&e)try{let t,o;if(e.includes('|')){const r=e.split('|').map(e=>e.trim());if(r.length>=2)t=r[0],o=r[r.length-1];else{o=e;const r=o.match(/([^/]+\.(?:mp3|wav|ogg))$/i);t=r?r[1].replace(/\.(mp3|wav|ogg)$/i,''):`éŸ³ä¹ ${n.length+1}`}}else{o=e;const r=o.match(/([^/]+\.(?:mp3|wav|ogg))$/i);t=r?r[1].replace(/\.(mp3|wav|ogg)$/i,''):`éŸ³ä¹ ${n.length+1}`}n.push({title:t,url:o})}catch(t){console.warn(`è§£æéŸ³ä¹é“¾æ¥å¤±è´¥: ${e}`,t)}n.length>0?(toastr.success(`å·²åŠ è½½ ${n.length} é¦–éŸ³ä¹ (${a})`,'éŸ³ä¹æ’­æ”¾å™¨'),L()):toastr.warning(`å½“å‰ä¸»é¢˜ (${a}) æ²¡æœ‰éŸ³ä¹`,'éŸ³ä¹æ’­æ”¾å™¨')}catch(e){console.error('åŠ è½½éŸ³ä¹å¤±è´¥:',e),toastr.error('åŠ è½½éŸ³ä¹å¤±è´¥','éŸ³ä¹æ’­æ”¾å™¨')}}function h(e){if(e<0||e>=n.length)return;o=e;const r=n[e];console.log('å°è¯•æ’­æ”¾éŸ³ä¹:',r),t&&(t.removeEventListener('error',d),t.removeEventListener('canplaythrough',m),t.addEventListener('error',d,{once:!0}),t.addEventListener('canplaythrough',m,{once:!0}),t.src=r.url,console.log('è®¾ç½®éŸ³é¢‘æº:',r.url),t.load()),function(e){const t={currentTrack:e,currentTrackIndex:o,isPlaying:!1,currentTheme:a,timestamp:Date.now()};try{localStorage.setItem(i,JSON.stringify(t))}catch(e){console.warn('ä¿å­˜æ’­æ”¾çŠ¶æ€å¤±è´¥:',e)}}(r),toastr.info(`æ­£åœ¨åŠ è½½: ${r.title}`,'éŸ³ä¹æ’­æ”¾å™¨')}function d(e){const t=e.target.error;console.error('éŸ³é¢‘åŠ è½½å¤±è´¥:',t);let n='æœªçŸ¥é”™è¯¯';if(t)switch(t.code){case MediaError.MEDIA_ERR_ABORTED:n='æ’­æ”¾è¢«ä¸­æ­¢';break;case MediaError.MEDIA_ERR_NETWORK:n='ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½éŸ³é¢‘';break;case MediaError.MEDIA_ERR_DECODE:n='éŸ³é¢‘è§£ç å¤±è´¥';break;case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:n='ä¸æ”¯æŒçš„éŸ³é¢‘æ ¼å¼æˆ–é“¾æ¥æ— æ•ˆ'}toastr.error(`éŸ³é¢‘åŠ è½½å¤±è´¥: ${n}`,'éŸ³ä¹æ’­æ”¾å™¨'),setTimeout(()=>{v()},2e3)}function m(){console.log('éŸ³é¢‘åŠ è½½å®Œæˆï¼Œå¼€å§‹æ’­æ”¾'),t&&t.play().catch(e=>{console.error('æ’­æ”¾å¤±è´¥:',e),toastr.error(`æ’­æ”¾å¤±è´¥: ${e.message}`,'éŸ³ä¹æ’­æ”¾å™¨')})}function E(){t&&0!==n.length?r?(t.pause(),toastr.info('å·²æš‚åœ','éŸ³ä¹æ’­æ”¾å™¨')):-1===o?h(0):t.play().catch(e=>{console.error('æ’­æ”¾å¤±è´¥:',e),toastr.error('æ’­æ”¾å¤±è´¥','éŸ³ä¹æ’­æ”¾å™¨')}):toastr.warning('æ²¡æœ‰å¯æ’­æ”¾çš„éŸ³ä¹','éŸ³ä¹æ’­æ”¾å™¨')}function v(){if(0===n.length)return;h((o+1)%n.length)}function p(){if(0===n.length)return;h(o<=0?n.length-1:o-1)}function w(){switch(s){case e.LOOP:s=e.SINGLE,toastr.info('å·²åˆ‡æ¢åˆ°å•æ›²å¾ªç¯','éŸ³ä¹æ’­æ”¾å™¨');break;case e.SINGLE:s=e.SHUFFLE,toastr.info('å·²åˆ‡æ¢åˆ°éšæœºæ’­æ”¾','éŸ³ä¹æ’­æ”¾å™¨');break;case e.SHUFFLE:s=e.LOOP,toastr.info('å·²åˆ‡æ¢åˆ°åˆ—è¡¨å¾ªç¯','éŸ³ä¹æ’­æ”¾å™¨')}u()}function O(){if(0===n.length)return void toastr.info('æ’­æ”¾åˆ—è¡¨ä¸ºç©º','éŸ³ä¹æ’­æ”¾å™¨');let e='ğŸµ æ’­æ”¾åˆ—è¡¨:\n\n';n.forEach((t,n)=>{e+=`${n===o?'â–¶ï¸':'  '} ${n+1}. ${t.title}\n`}),console.log(e),toastr.info('æŸ¥çœ‹æ§åˆ¶å°æŸ¥çœ‹å®Œæ•´æ’­æ”¾åˆ—è¡¨','éŸ³ä¹æ’­æ”¾å™¨')}function L(){const t=s===e.LOOP?'ğŸ”':s===e.SINGLE?'ğŸ”‚':'ğŸ”€',o=s===e.LOOP?'åˆ—è¡¨å¾ªç¯':s===e.SINGLE?'å•æ›²å¾ªç¯':'éšæœºæ’­æ”¾',r=[{name:'ğŸµ åŠ è½½éŸ³ä¹',visible:0===n.length},{name:'â–¶ï¸ æ’­æ”¾/æš‚åœ',visible:n.length>0},{name:'â®ï¸ ä¸Šä¸€é¦–',visible:n.length>0},{name:'â­ï¸ ä¸‹ä¸€é¦–',visible:n.length>0},{name:`${t} ${o}`,visible:n.length>0},{name:'ğŸ“‹ æ˜¾ç¤ºåˆ—è¡¨',visible:n.length>0}];replaceScriptButtons(r),n.length>0&&eventOn(getButtonEvent(`${t} ${o}`),()=>{w(),setTimeout(()=>L(),100)})}function y(){window.addEventListener('storage',e=>{if('fc_music_command'===e.key&&e.newValue)try{!function(e){switch(console.log('æ”¶åˆ°å‘½ä»¤:',e),e){case'toggle':E();break;case'next':v();break;case'previous':p();break;case'toggle_mode':w(),L();break;default:if(e.startsWith('play_')){const t=parseInt(e.substring(5));!isNaN(t)&&t>=0&&t<n.length&&h(t)}}}(JSON.parse(e.newValue).command)}catch(e){console.warn('è§£æå‘½ä»¤å¤±è´¥:',e)}})}$(()=>{l(),L(),window.addEventListener('storage',e=>{if('fate_console_ui_state'===e.key&&e.newValue)try{const t=JSON.parse(e.newValue).theme;t!==a&&(console.log('æ£€æµ‹åˆ°ä¸»é¢˜å˜åŒ–:',a,'->',t),a=t,f())}catch(e){console.warn('è§£æä¸»é¢˜å˜åŒ–å¤±è´¥:',e)}}),setInterval(()=>{const e=g();e!==a&&(console.log('æ£€æµ‹åˆ°ä¸»é¢˜å˜åŒ–ï¼ˆè½®è¯¢ï¼‰:',a,'->',e),a=e,f())},1e3),y(),eventOn(getButtonEvent('ğŸµ åŠ è½½éŸ³ä¹'),async()=>{await f()}),eventOn(getButtonEvent('â–¶ï¸ æ’­æ”¾/æš‚åœ'),E),eventOn(getButtonEvent('â®ï¸ ä¸Šä¸€é¦–'),p),eventOn(getButtonEvent('â­ï¸ ä¸‹ä¸€é¦–'),v),eventOn(getButtonEvent('ğŸ“‹ æ˜¾ç¤ºåˆ—è¡¨'),O),toastr.success('éŸ³ä¹æ’­æ”¾å™¨å·²å°±ç»ª','å‘½è¿ç»ˆç«¯')}),$(window).on('pagehide',()=>{t&&(t.pause(),t=null),toastr.info('éŸ³ä¹æ’­æ”¾å™¨å·²å¸è½½','å‘½è¿ç»ˆç«¯')});