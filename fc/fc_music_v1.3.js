var e;!function(e){e.LOOP='loop',e.SINGLE='single',e.SHUFFLE='shuffle'}(e||(e={}));let t=null,n=[],o=-1,r=!1,a='gufeng',s=e.LOOP,i='éŸ³ä¹',c=[];const l='fc_music_player_state';let u=0;function g(){if(!t){t=new Audio,t.volume=.7,t.addEventListener('ended',()=>{!function(){switch(s){case e.SINGLE:o>=0&&m(o);break;case e.SHUFFLE:if(n.length>1){let e;do{e=Math.floor(Math.random()*n.length)}while(e===o&&n.length>1);m(e)}else w();break;case e.LOOP:default:w()}}()}),t.addEventListener('play',()=>{r=!0,u=Date.now(),f()}),t.addEventListener('pause',()=>{r=!1,f()}),t.addEventListener('loadedmetadata',()=>{t&&f()});let a=0;t.addEventListener('timeupdate',()=>{if(t){const e=Date.now();e-a>=1e3&&(f(),a=e)}})}}function f(){if(!t)return;const e={isPlaying:r,currentTime:t.currentTime||0,duration:t.duration||180,playMode:s,timestamp:Date.now()};try{const t=localStorage.getItem(l);if(t){const n={...JSON.parse(t),...e};localStorage.setItem(l,JSON.stringify(n))}}catch(e){console.warn('ä¿å­˜æ’­æ”¾çŠ¶æ€å¤±è´¥:',e)}}function h(){try{const e=localStorage.getItem('fate_console_ui_state');if(e){return JSON.parse(e).theme||'gufeng'}}catch(e){console.warn('è¯»å–ä¸»é¢˜å¤±è´¥:',e)}return'gufeng'}async function d(e){try{e&&(i=e),a=h(),console.log('å½“å‰ä¸»é¢˜:',a,'ä½¿ç”¨æ¡ç›®:',i);const t=await getWorldbook('å‘½è¿ç»ˆç«¯');if(!t)return void toastr.error('æœªæ‰¾åˆ°"å‘½è¿ç»ˆç«¯"ä¸–ç•Œä¹¦','å‘½è¿æ­Œæ¨¡å—');const o=t.filter(e=>e.name.includes('éŸ³ä¹')||e.name.includes('å°æ›²')||e.name.includes('bgm'));c=o.map(e=>e.name);let r=t.find(e=>e.name===i&&e.enabled);if(!r&&o.length>0&&(r=o[0],i=r.name,console.log(`å›é€€åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨æ¡ç›®: ${i}`)),!r||!r.content)return void toastr.error('ä¸–ç•Œä¹¦ä¸­æœªæ‰¾åˆ°å¯ç”¨çš„éŸ³ä¹æ¡ç›®','å‘½è¿æ­Œæ¨¡å—');const s=r.content.split('\n').map(e=>e.trim()).filter(e=>e);n=[];const l={å¤é£:'gufeng',ä»™ä¾ :'xianxia',æ°‘ä¿—:'minsu',æ­¦ä¾ :'wuxia',ç„å¹»:'xuanhuan',æ—¥å¼:'nihon'},u=s.some(e=>e.endsWith('ï¼š')&&Object.prototype.hasOwnProperty.call(l,e.slice(0,-1)));let g='';for(const e of s)if(e.endsWith('ï¼š')){const t=e.slice(0,-1);g=l[t]||t}else if(e){if(!u||g===a)try{let t,o;if(e.includes('|')){const r=e.split('|').map(e=>e.trim());if(r.length>=2)t=r[0],o=r[r.length-1];else{o=e;const r=o.match(/([^/]+\.(?:mp3|wav|ogg))$/i);t=r?r[1].replace(/\.(mp3|wav|ogg)$/i,''):`éŸ³ä¹ ${n.length+1}`}}else{o=e;const r=o.match(/([^/]+\.(?:mp3|wav|ogg))$/i);t=r?r[1].replace(/\.(mp3|wav|ogg)$/i,''):`éŸ³ä¹ ${n.length+1}`}n.push({title:t,url:o})}catch(t){console.warn(`è§£æéŸ³ä¹é“¾æ¥å¤±è´¥: ${e}`,t)}}n.length>0?(toastr.success(`å·²åŠ è½½ ${n.length} é¦–éŸ³ä¹ (${a}) [${i}]`,'å‘½è¿æ­Œæ¨¡å—'),k()):toastr.warning(`å½“å‰ä¸»é¢˜ (${a}) æ²¡æœ‰éŸ³ä¹ [${i}]`,'éŸ³ä¹æ’­æ”¾å™¨')}catch(e){console.error('åŠ è½½éŸ³ä¹å¤±è´¥:',e),toastr.error('åŠ è½½éŸ³ä¹å¤±è´¥','å‘½è¿æ­Œæ¨¡å—')}}function m(e){if(e<0||e>=n.length)return;o=e;const r=n[e];console.log('å°è¯•æ’­æ”¾éŸ³ä¹:',r),t&&(t.removeEventListener('error',v),t.removeEventListener('canplaythrough',E),t.addEventListener('error',v,{once:!0}),t.addEventListener('canplaythrough',E,{once:!0}),t.src=r.url,console.log('è®¾ç½®éŸ³é¢‘æº:',r.url),t.load()),function(e){const t={currentTrack:e,currentTrackIndex:o,isPlaying:!1,currentTheme:a,timestamp:Date.now()};try{localStorage.setItem(l,JSON.stringify(t))}catch(e){console.warn('ä¿å­˜æ’­æ”¾çŠ¶æ€å¤±è´¥:',e)}}(r),toastr.info(`æ­£åœ¨åŠ è½½: ${r.title}`,'å‘½è¿æ­Œæ¨¡å—')}function v(e){const t=e.target.error;console.error('éŸ³é¢‘åŠ è½½å¤±è´¥:',t);let n='æœªçŸ¥é”™è¯¯';if(t)switch(t.code){case MediaError.MEDIA_ERR_ABORTED:n='æ’­æ”¾è¢«ä¸­æ­¢';break;case MediaError.MEDIA_ERR_NETWORK:n='ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½éŸ³é¢‘';break;case MediaError.MEDIA_ERR_DECODE:n='éŸ³é¢‘è§£ç å¤±è´¥';break;case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:n='ä¸æ”¯æŒçš„éŸ³é¢‘æ ¼å¼æˆ–é“¾æ¥æ— æ•ˆ'}toastr.error(`éŸ³é¢‘åŠ è½½å¤±è´¥: ${n}`,'å‘½è¿æ­Œæ¨¡å—'),setTimeout(()=>{w()},2e3)}function E(){console.log('éŸ³é¢‘åŠ è½½å®Œæˆï¼Œå¼€å§‹æ’­æ”¾'),t&&t.play().catch(e=>{console.error('æ’­æ”¾å¤±è´¥:',e),toastr.error(`æ’­æ”¾å¤±è´¥: ${e.message}`,'å‘½è¿æ­Œæ¨¡å—')})}function p(){t&&0!==n.length?r?(t.pause(),toastr.info('å·²æš‚åœ','å‘½è¿æ­Œæ¨¡å—')):-1===o?m(0):t.play().catch(e=>{console.error('æ’­æ”¾å¤±è´¥:',e),toastr.error('æ’­æ”¾å¤±è´¥','éŸ³ä¹æ’­æ”¾å™¨')}):toastr.warning('æ²¡æœ‰å¯æ’­æ”¾çš„éŸ³ä¹','å‘½è¿æ­Œæ¨¡å—')}function w(){if(0===n.length)return;m((o+1)%n.length)}function O(){if(0===n.length)return;m(o<=0?n.length-1:o-1)}function b(){switch(s){case e.LOOP:s=e.SINGLE,toastr.info('å·²åˆ‡æ¢åˆ°å•æ›²å¾ªç¯','å‘½è¿æ­Œæ¨¡å—');break;case e.SINGLE:s=e.SHUFFLE,toastr.info('å·²åˆ‡æ¢åˆ°éšæœºæ’­æ”¾','å‘½è¿æ­Œæ¨¡å—');break;case e.SHUFFLE:s=e.LOOP,toastr.info('å·²åˆ‡æ¢åˆ°åˆ—è¡¨å¾ªç¯','å‘½è¿æ­Œæ¨¡å—')}f()}function L(e){c.includes(e)&&e!==i?(console.log(`åˆ‡æ¢éŸ³ä¹æ¡ç›®: ${i} -> ${e}`),d(e)):toastr.warning(`éŸ³ä¹æ¡ç›®"${e}"ä¸å­˜åœ¨æˆ–å·²æ˜¯å½“å‰æ¡ç›®`,'å‘½è¿æ­Œæ¨¡å—')}function y(){if(0===c.length)return void toastr.info('æ²¡æœ‰æ‰¾åˆ°éŸ³ä¹æ¡ç›®','å‘½è¿æ­Œæ¨¡å—');let e='ğŸ¼ å¯ç”¨éŸ³ä¹æ¡ç›®:\n\n';c.forEach((t,n)=>{e+=`${t===i?'â–¶ï¸':'  '} ${n+1}. ${t}\n`}),console.log(e),toastr.info('æŸ¥çœ‹æ§åˆ¶å°æŸ¥çœ‹å®Œæ•´æ¡ç›®åˆ—è¡¨','å‘½è¿æ­Œæ¨¡å—')}function S(){if(0===n.length)return void toastr.info('æ’­æ”¾åˆ—è¡¨ä¸ºç©º','å‘½è¿æ­Œæ¨¡å—');let e='ğŸµ æ’­æ”¾åˆ—è¡¨:\n\n';n.forEach((t,n)=>{e+=`${n===o?'â–¶ï¸':'  '} ${n+1}. ${t.title}\n`}),console.log(e),toastr.info('æŸ¥çœ‹æ§åˆ¶å°æŸ¥çœ‹å®Œæ•´æ’­æ”¾åˆ—è¡¨','å‘½è¿æ­Œæ¨¡å—')}function k(){const t=s===e.LOOP?'ğŸ”':s===e.SINGLE?'ğŸ”‚':'ğŸ”€',o=s===e.LOOP?'åˆ—è¡¨å¾ªç¯':s===e.SINGLE?'å•æ›²å¾ªç¯':'éšæœºæ’­æ”¾',r=[{name:'ğŸµ åŠ è½½éŸ³ä¹',visible:0===n.length},{name:'â–¶ï¸ æ’­æ”¾/æš‚åœ',visible:n.length>0},{name:'â®ï¸ ä¸Šä¸€é¦–',visible:n.length>0},{name:'â­ï¸ ä¸‹ä¸€é¦–',visible:n.length>0},{name:`${t} ${o}`,visible:n.length>0},{name:'ğŸ“‹ æ˜¾ç¤ºåˆ—è¡¨',visible:n.length>0},{name:'ğŸ¼ åˆ‡æ¢æ¡ç›®',visible:c.length>1},{name:'ğŸ“‹ æ˜¾ç¤ºæ¡ç›®',visible:c.length>0}];replaceScriptButtons(r),n.length>0&&eventOn(getButtonEvent(`${t} ${o}`),()=>{b(),setTimeout(()=>k(),100)}),c.length>1&&eventOn(getButtonEvent('ğŸ¼ åˆ‡æ¢æ¡ç›®'),()=>{!function(){if(c.length<=1)return void toastr.info('åªæœ‰ä¸€ä¸ªéŸ³ä¹æ¡ç›®ï¼Œæ— éœ€åˆ‡æ¢','å‘½è¿æ­Œæ¨¡å—');const e=c.map(e=>({name:`${e===i?'â–¶ï¸':'ğŸµ'} ${e}`,visible:!0}));replaceScriptButtons(e),c.forEach(e=>{eventOn(getButtonEvent(`${e===i?'â–¶ï¸':'ğŸµ'} ${e}`),()=>{L(e),setTimeout(()=>k(),500)})}),toastr.info('ç‚¹å‡»æ¡ç›®åç§°åˆ‡æ¢éŸ³ä¹æ¥æº','å‘½è¿æ­Œæ¨¡å—')}()}),c.length>0&&eventOn(getButtonEvent('ğŸ“‹ æ˜¾ç¤ºæ¡ç›®'),y)}function I(){window.addEventListener('storage',e=>{if('fc_music_command'===e.key&&e.newValue)try{!function(e){switch(console.log('æ”¶åˆ°å‘½ä»¤:',e),e){case'toggle':p();break;case'next':w();break;case'previous':O();break;case'toggle_mode':b(),k();break;case'load_music':d();break;default:if(e.startsWith('play_')){const t=parseInt(e.substring(5));!isNaN(t)&&t>=0&&t<n.length&&m(t)}else if(e.startsWith('switch_entry_')){L(e.substring(13))}else if(e.startsWith('load_music_')){d(e.substring(11))}}}(JSON.parse(e.newValue).command)}catch(e){console.warn('è§£æå‘½ä»¤å¤±è´¥:',e)}})}$(()=>{g(),k(),window.addEventListener('storage',e=>{if('fate_console_ui_state'===e.key&&e.newValue)try{const t=JSON.parse(e.newValue).theme;t!==a&&(console.log('æ£€æµ‹åˆ°ä¸»é¢˜å˜åŒ–:',a,'->',t),a=t,d())}catch(e){console.warn('è§£æä¸»é¢˜å˜åŒ–å¤±è´¥:',e)}}),setInterval(()=>{const e=h();e!==a&&(console.log('æ£€æµ‹åˆ°ä¸»é¢˜å˜åŒ–ï¼ˆè½®è¯¢ï¼‰:',a,'->',e),a=e,d())},1e3),I(),eventOn(getButtonEvent('ğŸµ åŠ è½½éŸ³ä¹'),async()=>{await d()}),eventOn(getButtonEvent('â–¶ï¸ æ’­æ”¾/æš‚åœ'),p),eventOn(getButtonEvent('â®ï¸ ä¸Šä¸€é¦–'),O),eventOn(getButtonEvent('â­ï¸ ä¸‹ä¸€é¦–'),w),eventOn(getButtonEvent('ğŸ“‹ æ˜¾ç¤ºåˆ—è¡¨'),S),toastr.success('å‘½è¿æ­Œæ¨¡å—å·²å°±ç»ª','å‘½è¿ç»ˆç«¯')}),$(window).on('pagehide',()=>{t&&(t.pause(),t=null),toastr.info('å‘½è¿æ­Œæ¨¡å—å·²å¸è½½','å‘½è¿ç»ˆç«¯')});