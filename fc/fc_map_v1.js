const n={country:'ğŸš©',city:'ğŸ™ï¸',village:'ğŸ˜ï¸',district:'ğŸ˜ï¸',street:'ğŸ›£ï¸',camp:'ğŸ•ï¸',apartment:'ğŸ¢',mansion:'ğŸ°',castle:'ğŸ°',house:'ğŸ ',dungeon:'ğŸ•³ï¸',room:'ğŸ ',courtyard:'ğŸï¸',hall:'ğŸ›ï¸',gate:'ğŸšª',area:'ğŸ“',voidspace:'ğŸŒŒ'};function t(){const t=$('<button>').attr('id','fc-map-toggle').text('ğŸ—ºï¸').css({position:'fixed',bottom:'10px',right:'10px',zIndex:'10000',padding:'8px',background:'#007bff',color:'white',border:'none',borderRadius:'50%',cursor:'pointer',fontSize:'16px',width:'40px',height:'40px',display:'flex',alignItems:'center',justifyContent:'center',boxShadow:'0 2px 5px rgba(0,0,0,0.3)'}).attr('title','æ‰“å¼€åœ°å›¾').on('click',function(n){n.preventDefault(),n.stopPropagation();const t=$('#fc-map-panel');t.toggle(),t.is(':visible')&&setTimeout(()=>r(),100)}),o=$('\n    <div id="fc-map-panel" style="\n      position: fixed;\n      bottom: 60px;\n      right: 10px;\n      width: 350px;\n      height: 500px;\n      background: #2c3e50;\n      color: #ecf0f1;\n      border: 1px solid #34495e;\n      border-radius: 5px;\n      z-index: 1000;\n      display: none;\n      box-shadow: 0 2px 10px rgba(0,0,0,0.3);\n    ">\n      <div id="fc-map-header" style="\n        padding: 10px;\n        background: #34495e;\n        border-bottom: 1px solid #465c71;\n        border-radius: 5px 5px 0 0;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n      ">\n        <span style="font-weight: bold; color: #ecf0f1;">æ¸¸æˆåœ°å›¾</span>\n        <button id="fc-map-close" style="\n          background: none;\n          border: none;\n          font-size: 18px;\n          cursor: pointer;\n          color: #bdc3c7;\n        ">Ã—</button>\n      </div>\n      <div id="fc-map-content" style="\n        padding: 10px;\n        height: calc(100% - 50px);\n        overflow-y: auto;\n      ">\n        <div id="fc-map-toolbar" style="\n          width: 100%;\n          margin-bottom: 10px;\n          display: flex;\n          gap: 5px;\n          flex-wrap: wrap;\n        ">\n          <button id="fc-map-refresh" style="\n            padding: 4px 8px;\n            background: #007bff;\n            color: white;\n            border: none;\n            border-radius: 3px;\n            cursor: pointer;\n            font-size: 11px;\n          ">ğŸ”„ åˆ·æ–°</button>\n          <button id="fc-map-clear" style="\n            padding: 4px 8px;\n            background: #dc3545;\n            color: white;\n            border: none;\n            border-radius: 3px;\n            cursor: pointer;\n            font-size: 11px;\n          ">ğŸ—‘ï¸ æ¸…ç©º</button>\n          <button id="fc-map-import" style="\n            padding: 4px 8px;\n            background: #17a2b8;\n            color: white;\n            border: none;\n            border-radius: 3px;\n            cursor: pointer;\n            font-size: 11px;\n          ">ğŸ“¥ å¯¼å…¥</button>\n          <button id="fc-map-export" style="\n            padding: 4px 8px;\n            background: #28a745;\n            color: white;\n            border: none;\n            border-radius: 3px;\n            cursor: pointer;\n            font-size: 11px;\n          ">ğŸ“¤ å¯¼å‡º</button>\n        </div>\n        <div id="fc-map-info" style="\n          margin-bottom: 10px;\n          padding: 10px;\n          background: #34495e;\n          border: 1px solid #465c71;\n          border-radius: 3px;\n          color: #ecf0f1;\n          font-size: 12px;\n          line-height: 1.4;\n        ">\n          <div style="font-weight: bold; margin-bottom: 6px; font-size: 13px;">ğŸ“Š åœ°å›¾ä¿¡æ¯</div>\n          <div id="fc-map-stats" style="color: #bdc3c7;">æš‚æ— æ•°æ®</div>\n        </div>\n        <div id="fc-location-tree" style="\n          font-family: \'Microsoft YaHei\', sans-serif;\n          font-size: 13px;\n          color: #ecf0f1;\n          border: 1px solid #465c71;\n          border-radius: 3px;\n          height: 300px;\n          overflow-y: auto;\n          background: #34495e;\n          line-height: 1.4;\n        "></div>\n      </div>\n    </div>\n  ');async function r(){try{const t=e(),o=await getWorldbook(t),r=o.filter(n=>'åœ°å›¾çŸ¥è¯†æ±‡æ€»'!==n.name&&'å½“å‰ä½ç½®'!==n.name).map(n=>({name:n.name,x:n.extra?.x||0,y:n.extra?.y||0,description:n.extra?.description||'',type:n.extra?.type||'village',container:n.extra?.container,floor:n.extra?.floor})),c=o.find(n=>'å½“å‰ä½ç½®'===n.name),s=c?{name:c.extra?.name||'',x:c.extra?.x||0,y:c.extra?.y||0,type:c.extra?.type||'village',container:c.extra?.container,floor:c.extra?.floor}:void 0;!function(t){const e=$('#fc-location-tree');if(e.empty(),0===t.length)return void e.append('<div style="color: #95a5a6; text-align: center; padding: 20px;">æš‚æ— åœ°ç‚¹æ•°æ®</div>');const o=function(n){const t=[],e=n.filter(n=>!n.container);return e.forEach(e=>{const o={location:e,children:[]},r=n.filter(n=>n.container===e.name);o.children=i(r,n),t.push(o)}),t}(t);function r(t,o=0){t.forEach(t=>{const r=20*o,i=t.children&&t.children.length>0,c=$(`\n          <div class="tree-node" data-depth="${o}" style="\n            padding: 2px 0;\n            padding-left: ${r}px;\n            cursor: pointer;\n            display: flex;\n            align-items: center;\n            color: #ecf0f1;\n          ">\n            ${i?'<span class="expand-btn" style="\n            width: 16px;\n            text-align: center;\n            color: #bdc3c7;\n          ">â–¶</span>':'<span style="width: 16px;"></span>'}\n            <span class="location-icon" style="margin: 0 5px;">${n[t.location.type]||'ğŸ“'}</span>\n            <span class="location-name" style="flex: 1; color: #ecf0f1; font-size: 13px;">${t.location.name}</span>\n            ${void 0!==t.location.x?`<span style="color: #95a5a6; font-size: 11px;">(${t.location.x},${t.location.y})</span>`:''}\n          </div>\n        `);if(e.append(c),c.find('.location-name').on('click',function(n){n.stopPropagation(),a(t.location)}),c.find('.location-icon').on('click',function(n){n.stopPropagation(),a(t.location)}),i){function s(t,o){t.forEach(t=>{const r=20*o,i=t.children&&t.children.length>0,c=$(`\n                <div class="tree-node" data-depth="${o}" style="\n                  padding: 2px 0;\n                  padding-left: ${r}px;\n                  cursor: pointer;\n                  display: block;\n                  align-items: center;\n                  color: #ecf0f1;\n                ">\n                  ${i?'<span class="expand-btn" style="\n                width: 16px;\n                text-align: center;\n                color: #bdc3c7;\n              ">â–¶</span>':'<span style="width: 16px;"></span>'}\n                  <span class="location-icon" style="margin: 0 5px;">${n[t.location.type]||'ğŸ“'}</span>\n                  <span class="location-name" style="flex: 1; color: #ecf0f1; font-size: 13px;">${t.location.name}</span>\n                  ${void 0!==t.location.x?`<span style="color: #95a5a6; font-size: 11px;">(${t.location.x},${t.location.y})</span>`:''}\n                </div>\n              `);e.append(c),c.find('.location-name').on('click',function(n){n.stopPropagation(),a(t.location)}),c.find('.location-icon').on('click',function(n){n.stopPropagation(),a(t.location)}),i&&s(t.children,o+1)})}s(t.children,o+1)}})}r(o)}(r),function(n,t){const e=$('#fc-map-stats');if(0===n.length)return void e.html('æš‚æ— åœ°å›¾æ•°æ®');const o=n.length,r=n.filter(n=>{return t=n.type,['country','city','village','district','street','building','mansion','castle','dungeon'].includes(t);var t}).length,i=o-r,a=n.filter(n=>{return t=n.type,['building','mansion','castle','dungeon'].includes(t);var t}).length;let c=`\n      <div>åœ°ç‚¹æ€»æ•°: ${o}</div>\n      <div>å®¤å¤–åœ°ç‚¹: ${r}</div>\n      <div>å®¤å†…åœ°ç‚¹: ${i}</div>\n      <div>å»ºç­‘ç‰©: ${a}</div>\n    `;t&&(c+=`<div style="margin-top: 4px; color: #e74c3c;">å½“å‰ä½ç½®: ${t.name}</div>`);e.html(c)}(r,s)}catch(n){console.error('æ›´æ–°åœ°å›¾æ˜¾ç¤ºå¤±è´¥:',n)}}function i(n,t){return n.map(n=>{const e={location:n,children:[]},o=t.filter(t=>t.container===n.name);return e.children=i(o,t),e})}function a(n){const t=`\n<div style="line-height: 1.6; max-width: 300px;">\n  <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">ğŸ“ ${n.name}</div>\n  <div style="margin-bottom: 4px;"><strong>åæ ‡:</strong> (${n.x}, ${n.y})</div>\n  <div style="margin-bottom: 4px;"><strong>ç±»å‹:</strong> ${n.type}</div>\n  ${n.container?`<div style="margin-bottom: 4px;"><strong>ğŸ¢ ä½äº:</strong> ${n.container}</div>`:''}\n  ${n.floor?`<div style="margin-bottom: 8px;"><strong>ğŸ  æ¥¼å±‚:</strong> ${n.floor}</div>`:''}\n\n  <div style="border-top: 1px solid #ddd; padding-top: 8px; margin-top: 8px;">\n    <div style="margin-bottom: 4px;"><strong>ğŸ“ æè¿°:</strong></div>\n    <div style="color: #fff; font-size: 14px; line-height: 1.5;">${n.description||'æš‚æ— è¯¦ç»†æè¿°'}</div>\n  </div>\n</div>\n    `.trim();toastr.info(t,'åœ°ç‚¹è¯¦æƒ…',{timeOut:2e4,positionClass:'toast-top-center',escapeHtml:!1})}$('body').append(t),$('body').append(o),console.log('âœ… åœ°å›¾æŒ‰é’®å’Œé¢æ¿å·²æ·»åŠ åˆ°é¡µé¢'),setTimeout(()=>{const n=$('#fc-map-toggle');0===n.length?console.error('âŒ æŒ‰é’®æ·»åŠ å¤±è´¥ï¼'):(console.log('âœ… æŒ‰é’®æ·»åŠ æˆåŠŸï¼Œä½ç½®:',n.offset()),console.log('ğŸ”§ ç»‘å®šå·¥å…·æ æŒ‰é’®äº‹ä»¶'),$('#fc-map-refresh').off('click').on('click',async function(n){n.preventDefault(),n.stopPropagation();try{await r(),toastr.success('åœ°å›¾å·²åˆ·æ–°','ç³»ç»Ÿæç¤º',{timeOut:2e3})}catch(n){console.error('åˆ·æ–°å¤±è´¥:',n),toastr.error('åˆ·æ–°å¤±è´¥','é”™è¯¯',{timeOut:3e3})}}),$('#fc-map-clear').off('click').on('click',async function(n){if(n.preventDefault(),n.stopPropagation(),confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰åœ°å›¾æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼'))try{const n=e();await updateWorldbookWith(n,()=>[],{render:'immediate'}),await r(),toastr.success('åœ°å›¾æ•°æ®å·²æ¸…ç©º','ç³»ç»Ÿæç¤º',{timeOut:3e3})}catch(n){console.error('æ¸…ç©ºå¤±è´¥:',n),toastr.error('æ¸…ç©ºå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°','é”™è¯¯',{timeOut:5e3})}}),$('#fc-map-import').off('click').on('click',async function(n){n.preventDefault(),n.stopPropagation();const t=document.createElement('input');t.type='file',t.accept='.json',t.style.display='none',t.onchange=async n=>{const t=n.target.files?.[0];if(t)try{const n=await t.text(),o=JSON.parse(n);if(!o.locations||!Array.isArray(o.locations))throw new Error('æ— æ•ˆçš„åœ°å›¾æ•°æ®æ ¼å¼');if(console.log('ğŸ“¥ è§£æåˆ°å¯¼å…¥æ•°æ®:',o),!confirm(`ç¡®å®šè¦å¯¼å…¥ ${o.locations.length} ä¸ªåœ°ç‚¹å—ï¼Ÿè¿™å°†è¦†ç›–ç°æœ‰æ•°æ®ï¼`))return;const i=e();try{await getWorldbook(i),console.log(`ğŸ“š ä¸–ç•Œä¹¦ ${i} å·²å­˜åœ¨`)}catch{await createOrReplaceWorldbook(i,[],{render:'immediate'}),console.log(`ğŸ“š åˆ›å»ºæ–°ä¸–ç•Œä¹¦: ${i}`);const n=getCharWorldbookNames('current');n.additional.includes(i)||(await rebindCharWorldbooks('current',{primary:n.primary,additional:[...n.additional,i]}),console.log(`ğŸ—ºï¸ åœ°å›¾ä¸–ç•Œä¹¦å·²ç»‘å®šåˆ°å½“å‰è§’è‰²å¡: ${i}`))}const a=o.locations.map(n=>({uid:Date.now()+Math.random(),name:n.name,content:`åœ°ç‚¹: ${n.name}\nåæ ‡: (${n.x},${n.y})\næè¿°: ${n.description}\nç±»å‹: ${n.type}${n.container?`\nå®¹å™¨: ${n.container}`:''}${n.floor?`\næ¥¼å±‚: ${n.floor}`:''}\n---`,enabled:!0,strategy:{type:'selective',keys:[n.name,`(${n.x},${n.y})`]},position:{type:'after_character_definition',order:0},probability:100,recursion:{prevent_incoming:!0,prevent_outgoing:!0,delay_until:null},extra:{x:n.x,y:n.y,description:n.description,type:n.type,container:n.container,floor:n.floor,discovered_at:n.discovered_at||Date.now(),imported_at:Date.now()}}));await updateWorldbookWith(i,()=>a,{render:'immediate'}),await r(),toastr.success(`æˆåŠŸå¯¼å…¥ ${o.locations.length} ä¸ªåœ°ç‚¹`,'ç³»ç»Ÿæç¤º',{timeOut:3e3})}catch(n){console.error('å¯¼å…¥å¤±è´¥:',n),toastr.error('å¯¼å…¥å¤±è´¥ï¼š'+n.message,'é”™è¯¯',{timeOut:5e3})}},document.body.appendChild(t),t.click(),document.body.removeChild(t)}),$('#fc-map-export').off('click').on('click',async function(n){n.preventDefault(),n.stopPropagation();try{const n=e(),t=await getWorldbook(n),o={exported_at:(new Date).toISOString(),locations:t.filter(n=>'åœ°å›¾çŸ¥è¯†æ±‡æ€»'!==n.name&&'å½“å‰ä½ç½®'!==n.name).map(n=>({name:n.name,x:n.extra?.x||0,y:n.extra?.y||0,description:n.extra?.description||'',type:n.extra?.type||'village',container:n.extra?.container,floor:n.extra?.floor,discovered_at:n.extra?.discovered_at}))},r=JSON.stringify(o,null,2),i='data:application/json;charset=utf-8,'+encodeURIComponent(r),a=`fc_map_export_${(new Date).toISOString().split('T')[0]}.json`,c=document.createElement('a');c.setAttribute('href',i),c.setAttribute('download',a),c.click(),toastr.success('åœ°å›¾æ•°æ®å·²å¯¼å‡º','ç³»ç»Ÿæç¤º',{timeOut:3e3})}catch(n){console.error('å¯¼å‡ºå¤±è´¥:',n),toastr.error('å¯¼å‡ºå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°','é”™è¯¯',{timeOut:5e3})}}),console.log('âœ… å·¥å…·æ æŒ‰é’®äº‹ä»¶ç»‘å®šå®Œæˆ'))},100),$('#fc-map-close').off('click').on('click',function(n){n.preventDefault(),n.stopPropagation(),$('#fc-map-panel').hide()})}function e(){try{const n=SillyTavern?.characterId;if(n&&SillyTavern?.characters?.[n]){return`${SillyTavern.characters[n].name||'æœªçŸ¥è§’è‰²'}(æ¸¸æˆåœ°å›¾)`}return'é»˜è®¤è§’è‰²(æ¸¸æˆåœ°å›¾)'}catch(n){return console.error('è·å–è§’è‰²å¡ä¿¡æ¯å¤±è´¥:',n),'é»˜è®¤è§’è‰²(æ¸¸æˆåœ°å›¾)'}}$(()=>{async function n(n,t){const o=function(n){const t={locations:[]},e=n.match(/<fc_map>([\s\S]*?)<\/fc_map>/);if(!e)return console.log('âŒ æœªæ‰¾åˆ° <fc_map> æ ‡ç­¾'),t;try{const n=(new DOMParser).parseFromString(e[0],'text/xml'),o=n.getElementsByTagName('parsererror');if(o.length>0)return console.error('ğŸš¨ XMLè§£æé”™è¯¯:',o[0].textContent),t;const r=n.getElementsByTagName('location');for(let n=0;n<r.length;n++){const e=r[n],o=e.getAttribute('name'),i=parseFloat(e.getAttribute('x')||'0'),a=parseFloat(e.getAttribute('y')||'0'),c=e.getAttribute('desc')||e.textContent?.trim()||'',s=e.getAttribute('type')||'city',l=e.getAttribute('container')||void 0,d=e.getAttribute('floor')?parseInt(e.getAttribute('floor')):void 0;o?t.locations.push({name:o,x:i,y:a,description:c,type:s,container:l,floor:d}):console.warn(`âš ï¸ åœ°ç‚¹ ${n+1} ç¼ºå°‘åç§°å±æ€§`)}const i=n.getElementsByTagName('current_location');if(i.length>0){const n=i[0],e=n.getAttribute('name'),o=parseFloat(n.getAttribute('x')||'0'),r=parseFloat(n.getAttribute('y')||'0'),a=n.getAttribute('type')||'city',c=n.getAttribute('container')||void 0,s=n.getAttribute('floor')?parseInt(n.getAttribute('floor')):void 0;e&&(t.currentLocation={name:e,x:o,y:r,type:a,container:c,floor:s})}}catch(n){console.error('ğŸ’¥ XMLè§£æå¼‚å¸¸:',n)}return t}(n.content);if(o.locations.length>0||o.currentLocation){const n=e();try{await getWorldbook(n)}catch{await createOrReplaceWorldbook(n,[],{render:'immediate'})}const r=getCharWorldbookNames('current');r.additional.includes(n)||await rebindCharWorldbooks('current',{primary:r.primary,additional:[...r.additional,n]}),await updateWorldbookWith(n,n=>{for(const e of o.locations){const o=n.findIndex(n=>n.name===e.name);if(o>=0){const r=n[o];r.content=`åœ°ç‚¹: ${e.name}\nåæ ‡: (${r.extra.x}, ${r.extra.y})\næè¿°: ${e.description}\nç±»å‹: ${e.type}${e.container?`\nå®¹å™¨: ${e.container}`:''}${e.floor?`\næ¥¼å±‚: ${e.floor}`:''}\n---`,r.extra={...r.extra,description:e.description,type:e.type,container:e.container,floor:e.floor,updated_at:Date.now(),source:t}}else n.push({uid:Date.now()+Math.random(),name:e.name,content:`åœ°ç‚¹: ${e.name}\nåæ ‡: (${e.x}, ${e.y})\næè¿°: ${e.description}\nç±»å‹: ${e.type}${e.container?`\nå®¹å™¨: ${e.container}`:''}${e.floor?`\næ¥¼å±‚: ${e.floor}`:''}\n---`,enabled:!0,strategy:{type:'selective',keys:[e.name,`(${e.x},${e.y})`]},position:{type:'after_character_definition',order:0},probability:100,recursion:{prevent_incoming:!0,prevent_outgoing:!0,delay_until:null},extra:{x:e.x,y:e.y,description:e.description,type:e.type,container:e.container,floor:e.floor,discovered_at:Date.now(),source:t}})}if(o.currentLocation){const e=n.findIndex(n=>'å½“å‰ä½ç½®'===n.name),r={uid:Date.now()+Math.random(),name:'å½“å‰ä½ç½®',content:`å½“å‰ä½ç½®: ${o.currentLocation.name}(${o.currentLocation.x}, ${o.currentLocation.y})\nç±»å‹: ${o.currentLocation.type}${o.currentLocation.container?`\nå®¹å™¨: ${o.currentLocation.container}`:''}${o.currentLocation.floor?`\næ¥¼å±‚: ${o.currentLocation.floor}`:''}`,enabled:!0,strategy:{type:'constant'},position:{type:'before_character_definition',order:0},probability:100,recursion:{prevent_incoming:!0,prevent_outgoing:!0,delay_until:null},extra:{is_current_location:!0,...o.currentLocation,updated_at:Date.now(),source:t}};e>=0?n[e]=r:n.push(r)}return n},{render:'immediate'}),await async function(){try{const n=e(),t=(await getWorldbook(n)).filter(n=>'åœ°å›¾çŸ¥è¯†æ±‡æ€»'!==n.name&&'å½“å‰ä½ç½®'!==n.name);if(t.length>0){const e=`å·²çŸ¥åœ°ç‚¹åˆ—è¡¨ï¼š\n| åœ°ç‚¹åç§° | åæ ‡ | ç±»å‹ | å®¹å™¨ | æ¥¼å±‚ |\n|----------|------|------|--------|------|\n${t.map(n=>`| ${n.name} | (${n.extra?.x||0},${n.extra?.y||0}) | ${n.extra?.type||'outdoor'} | ${n.extra?.container||'-'} | ${n.extra?.floor||'-'} |`).join('\n')}`;await updateWorldbookWith(n,n=>{const t=n.find(n=>'åœ°å›¾çŸ¥è¯†æ±‡æ€»'===n.name);return t?t.content=e:n.push({uid:Date.now()+Math.random(),name:'åœ°å›¾çŸ¥è¯†æ±‡æ€»',content:e,enabled:!0,strategy:{type:'constant'},position:{type:'before_character_definition',order:0},probability:100}),n},{render:'immediate'})}}catch(n){console.error('ğŸ’¥ æ›´æ–°åœ°å›¾çŸ¥è¯†æ±‡æ€»å¤±è´¥:',n)}}();const i=o.locations.length,a=o.currentLocation?1:0;toastr.success(`ğŸ“ [${t}] æ›´æ–°åœ°å›¾æ•°æ®: ${i} ä¸ªåœ°ç‚¹${a?' + å½“å‰ä½ç½®':''}`)}}console.log('ğŸš€ FCåœ°å›¾ç³»ç»Ÿå·²åŠ è½½'),toastr.success('FCåœ°å›¾ç³»ç»Ÿå·²åŠ è½½','ç³»ç»Ÿæç¤º',{timeOut:3e3,positionClass:'toast-top-right'}),t(),console.log('âœ… åœ°å›¾ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œç›‘å¬äº‹ä»¶å·²è®¾ç½®'),eventOn(tavern_events.MESSAGE_RECEIVED,async t=>{try{const e=getChatMessages(t)[0];e&&e.message&&await n({content:e.message,id:t,is_user:'user'===e.role},'AIå›å¤')}catch(n){console.error('ğŸ’¥ è·å–æ–°æ¶ˆæ¯å¤±è´¥:',n)}}),eventOn(tavern_events.MESSAGE_EDITED,async t=>{try{const e=getChatMessages(t)[0];e&&e.message&&await n({content:e.message,id:t,is_user:'user'===e.role},'æ¶ˆæ¯ç¼–è¾‘')}catch(n){console.error('ğŸ’¥ è·å–ç¼–è¾‘æ¶ˆæ¯å¤±è´¥:',n)}})});