const n={country:'ğŸŒ',city:'ğŸ™ï¸',village:'ğŸ˜ï¸',district:'ğŸ˜ï¸',street:'ğŸ›£ï¸',building:'ğŸ¢',mansion:'ğŸ°',castle:'ğŸ°',dungeon:'ğŸ•³ï¸',room:'ğŸ ',courtyard:'ğŸï¸',gate:'ğŸšª'};function t(){const t=$('<button>').attr('id','fc-map-toggle').text('ğŸ—ºï¸').css({position:'fixed',top:'10px',right:'10px',zIndex:'10000',padding:'8px',background:'#007bff',color:'white',border:'none',borderRadius:'50%',cursor:'pointer',fontSize:'16px',width:'40px',height:'40px',display:'flex',alignItems:'center',justifyContent:'center',boxShadow:'0 2px 5px rgba(0,0,0,0.3)'}).attr('title','æ‰“å¼€åœ°å›¾').on('click',function(n){n.preventDefault(),n.stopPropagation();const t=$('#fc-map-panel');t.toggle(),t.is(':visible')&&setTimeout(()=>r(),100)}),e=$('\n    <div id="fc-map-panel" style="\n      position: fixed;\n      top: 60px;\n      right: 10px;\n      width: 350px;\n      height: 500px;\n      background: #2c3e50;\n      color: #ecf0f1;\n      border: 1px solid #34495e;\n      border-radius: 5px;\n      z-index: 1000;\n      display: none;\n      box-shadow: 0 2px 10px rgba(0,0,0,0.3);\n    ">\n      <div id="fc-map-header" style="\n        padding: 10px;\n        background: #34495e;\n        border-bottom: 1px solid #465c71;\n        border-radius: 5px 5px 0 0;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n      ">\n        <span style="font-weight: bold; color: #ecf0f1;">æ¸¸æˆåœ°å›¾</span>\n        <button id="fc-map-close" style="\n          background: none;\n          border: none;\n          font-size: 18px;\n          cursor: pointer;\n          color: #bdc3c7;\n        ">Ã—</button>\n      </div>\n      <div id="fc-map-content" style="\n        padding: 10px;\n        height: calc(100% - 50px);\n        overflow-y: auto;\n      ">\n        <div id="fc-map-toolbar" style="\n          width: 100%;\n          margin-bottom: 10px;\n          display: flex;\n          gap: 5px;\n          flex-wrap: wrap;\n        ">\n          <button id="fc-map-refresh" style="\n            padding: 4px 8px;\n            background: #007bff;\n            color: white;\n            border: none;\n            border-radius: 3px;\n            cursor: pointer;\n            font-size: 11px;\n          ">ğŸ”„ åˆ·æ–°</button>\n          <button id="fc-map-clear" style="\n            padding: 4px 8px;\n            background: #dc3545;\n            color: white;\n            border: none;\n            border-radius: 3px;\n            cursor: pointer;\n            font-size: 11px;\n          ">ğŸ—‘ï¸ æ¸…ç©º</button>\n          <button id="fc-map-import" style="\n            padding: 4px 8px;\n            background: #17a2b8;\n            color: white;\n            border: none;\n            border-radius: 3px;\n            cursor: pointer;\n            font-size: 11px;\n          ">ğŸ“¥ å¯¼å…¥</button>\n          <button id="fc-map-export" style="\n            padding: 4px 8px;\n            background: #28a745;\n            color: white;\n            border: none;\n            border-radius: 3px;\n            cursor: pointer;\n            font-size: 11px;\n          ">ğŸ“¤ å¯¼å‡º</button>\n        </div>\n        <div id="fc-map-info" style="\n          margin-bottom: 10px;\n          padding: 10px;\n          background: #34495e;\n          border: 1px solid #465c71;\n          border-radius: 3px;\n          color: #ecf0f1;\n          font-size: 12px;\n          line-height: 1.4;\n        ">\n          <div style="font-weight: bold; margin-bottom: 6px; font-size: 13px;">ğŸ“Š åœ°å›¾ä¿¡æ¯</div>\n          <div id="fc-map-stats" style="color: #bdc3c7;">æš‚æ— æ•°æ®</div>\n        </div>\n        <div id="fc-location-tree" style="\n          font-family: \'Microsoft YaHei\', sans-serif;\n          font-size: 13px;\n          color: #ecf0f1;\n          border: 1px solid #465c71;\n          border-radius: 3px;\n          height: 300px;\n          overflow-y: auto;\n          background: #34495e;\n          line-height: 1.4;\n        "></div>\n      </div>\n    </div>\n  ');async function r(){try{const t=o(),e=await getWorldbook(t),r=e.filter(n=>'åœ°å›¾çŸ¥è¯†æ±‡æ€»'!==n.name&&'å½“å‰ä½ç½®'!==n.name).map(n=>({name:n.name,x:n.extra?.x||0,y:n.extra?.y||0,description:n.extra?.description||'',type:n.extra?.type||'village',container:n.extra?.container,floor:n.extra?.floor})),c=e.find(n=>'å½“å‰ä½ç½®'===n.name),l=c?{name:c.extra?.name||'',x:c.extra?.x||0,y:c.extra?.y||0,type:c.extra?.type||'village',container:c.extra?.container,floor:c.extra?.floor}:void 0;!function(t){const o=$('#fc-location-tree');if(o.empty(),0===t.length)return void o.append('<div style="color: #95a5a6; text-align: center; padding: 20px;">æš‚æ— åœ°ç‚¹æ•°æ®</div>');const e=function(n){const t=[],o=n.filter(n=>!n.container);return o.forEach(o=>{const e={location:o,children:[]},r=n.filter(n=>n.container===o.name);e.children=i(r,n),t.push(e)}),t}(t);function r(t,e=0){t.forEach(t=>{const r=20*e,i=t.children&&t.children.length>0,c=$(`\n          <div class="tree-node" data-depth="${e}" style="\n            padding: 2px 0;\n            padding-left: ${r}px;\n            cursor: pointer;\n            display: flex;\n            align-items: center;\n            color: #ecf0f1;\n          ">\n            ${i?'<span class="expand-btn" style="\n            width: 16px;\n            text-align: center;\n            color: #bdc3c7;\n          ">â–¶</span>':'<span style="width: 16px;"></span>'}\n            <span class="location-icon" style="margin: 0 5px;">${n[t.location.type]||'ğŸ“'}</span>\n            <span class="location-name" style="flex: 1; color: #ecf0f1; font-size: 13px;">${t.location.name}</span>\n            ${void 0!==t.location.x?`<span style="color: #95a5a6; font-size: 11px;">(${t.location.x},${t.location.y})</span>`:''}\n          </div>\n        `);if(o.append(c),c.find('.location-name').on('click',function(n){n.stopPropagation(),a(t.location)}),c.find('.location-icon').on('click',function(n){n.stopPropagation(),a(t.location)}),i){function l(t,e){t.forEach(t=>{const r=20*e,i=t.children&&t.children.length>0,c=$(`\n                <div class="tree-node" data-depth="${e}" style="\n                  padding: 2px 0;\n                  padding-left: ${r}px;\n                  cursor: pointer;\n                  display: block;\n                  align-items: center;\n                  color: #ecf0f1;\n                ">\n                  ${i?'<span class="expand-btn" style="\n                width: 16px;\n                text-align: center;\n                color: #bdc3c7;\n              ">â–¶</span>':'<span style="width: 16px;"></span>'}\n                  <span class="location-icon" style="margin: 0 5px;">${n[t.location.type]||'ğŸ“'}</span>\n                  <span class="location-name" style="flex: 1; color: #ecf0f1; font-size: 13px;">${t.location.name}</span>\n                  ${void 0!==t.location.x?`<span style="color: #95a5a6; font-size: 11px;">(${t.location.x},${t.location.y})</span>`:''}\n                </div>\n              `);o.append(c),c.find('.location-name').on('click',function(n){n.stopPropagation(),a(t.location)}),c.find('.location-icon').on('click',function(n){n.stopPropagation(),a(t.location)}),i&&l(t.children,e+1)})}l(t.children,e+1)}})}r(e)}(r),function(n,t){const o=$('#fc-map-stats');if(0===n.length)return void o.html('æš‚æ— åœ°å›¾æ•°æ®');const e=n.length,r=n.filter(n=>{return t=n.type,['country','city','village','district','street','building','mansion','castle','dungeon'].includes(t);var t}).length,i=e-r,a=n.filter(n=>{return t=n.type,['building','mansion','castle','dungeon'].includes(t);var t}).length;let c=`\n      <div>åœ°ç‚¹æ€»æ•°: ${e}</div>\n      <div>å®¤å¤–åœ°ç‚¹: ${r}</div>\n      <div>å®¤å†…åœ°ç‚¹: ${i}</div>\n      <div>å»ºç­‘ç‰©: ${a}</div>\n    `;t&&(c+=`<div style="margin-top: 4px; color: #e74c3c;">å½“å‰ä½ç½®: ${t.name}</div>`);o.html(c)}(r,l)}catch(n){console.error('æ›´æ–°åœ°å›¾æ˜¾ç¤ºå¤±è´¥:',n)}}function i(n,t){return n.map(n=>{const o={location:n,children:[]},e=t.filter(t=>t.container===n.name);return o.children=i(e,t),o})}function a(n){const t=`\n<div style="line-height: 1.6; max-width: 300px;">\n  <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">ğŸ“ ${n.name}</div>\n  <div style="margin-bottom: 4px;"><strong>åæ ‡:</strong> (${n.x}, ${n.y})</div>\n  <div style="margin-bottom: 4px;"><strong>ç±»å‹:</strong> ${n.type}</div>\n  ${n.container?`<div style="margin-bottom: 4px;"><strong>ğŸ¢ ä½äº:</strong> ${n.container}</div>`:''}\n  ${n.floor?`<div style="margin-bottom: 8px;"><strong>ğŸ  æ¥¼å±‚:</strong> ${n.floor}</div>`:''}\n\n  <div style="border-top: 1px solid #ddd; padding-top: 8px; margin-top: 8px;">\n    <div style="margin-bottom: 4px;"><strong>ğŸ“ æè¿°:</strong></div>\n    <div style="color: #ecf0f1; font-size: 14px; line-height: 1.5;">${n.description||'æš‚æ— è¯¦ç»†æè¿°'}</div>\n  </div>\n</div>\n    `.trim();toastr.info(t,'åœ°ç‚¹è¯¦æƒ…',{timeOut:2e4,positionClass:'toast-top-center',escapeHtml:!1})}$('body').append(t),$('body').append(e),console.log('âœ… åœ°å›¾æŒ‰é’®å’Œé¢æ¿å·²æ·»åŠ åˆ°é¡µé¢'),setTimeout(()=>{const n=$('#fc-map-toggle');console.log('æŒ‰é’®å…ƒç´ æ£€æŸ¥:',n.length,n[0]),0===n.length?console.error('âŒ æŒ‰é’®æ·»åŠ å¤±è´¥ï¼'):(console.log('âœ… æŒ‰é’®æ·»åŠ æˆåŠŸï¼Œä½ç½®:',n.offset()),console.log('ğŸ”§ ç»‘å®šå·¥å…·æ æŒ‰é’®äº‹ä»¶'),$('#fc-map-refresh').off('click').on('click',async function(n){console.log('ğŸ”„ åˆ·æ–°æŒ‰é’®è¢«ç‚¹å‡»'),n.preventDefault(),n.stopPropagation();try{await r(),toastr.success('åœ°å›¾å·²åˆ·æ–°','ç³»ç»Ÿæç¤º',{timeOut:2e3})}catch(n){console.error('åˆ·æ–°å¤±è´¥:',n),toastr.error('åˆ·æ–°å¤±è´¥','é”™è¯¯',{timeOut:3e3})}}),$('#fc-map-clear').off('click').on('click',async function(n){if(console.log('ğŸ—‘ï¸ æ¸…ç©ºæŒ‰é’®è¢«ç‚¹å‡»'),n.preventDefault(),n.stopPropagation(),confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰åœ°å›¾æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼'))try{const n=o();await updateWorldbookWith(n,()=>[],{render:'immediate'}),await r(),toastr.success('åœ°å›¾æ•°æ®å·²æ¸…ç©º','ç³»ç»Ÿæç¤º',{timeOut:3e3})}catch(n){console.error('æ¸…ç©ºå¤±è´¥:',n),toastr.error('æ¸…ç©ºå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°','é”™è¯¯',{timeOut:5e3})}}),$('#fc-map-import').off('click').on('click',async function(n){console.log('ğŸ“¥ å¯¼å…¥æŒ‰é’®è¢«ç‚¹å‡»'),n.preventDefault(),n.stopPropagation();const t=document.createElement('input');t.type='file',t.accept='.json',t.style.display='none',t.onchange=async n=>{const t=n.target.files?.[0];if(t)try{const n=await t.text(),e=JSON.parse(n);if(!e.locations||!Array.isArray(e.locations))throw new Error('æ— æ•ˆçš„åœ°å›¾æ•°æ®æ ¼å¼');if(console.log('ğŸ“¥ è§£æåˆ°å¯¼å…¥æ•°æ®:',e),!confirm(`ç¡®å®šè¦å¯¼å…¥ ${e.locations.length} ä¸ªåœ°ç‚¹å—ï¼Ÿè¿™å°†è¦†ç›–ç°æœ‰æ•°æ®ï¼`))return;const i=o();try{await getWorldbook(i),console.log(`ğŸ“š ä¸–ç•Œä¹¦ ${i} å·²å­˜åœ¨`)}catch{await createOrReplaceWorldbook(i,[],{render:'immediate'}),console.log(`ğŸ“š åˆ›å»ºæ–°ä¸–ç•Œä¹¦: ${i}`);const n=getCharWorldbookNames('current');n.additional.includes(i)||(await rebindCharWorldbooks('current',{primary:n.primary,additional:[...n.additional,i]}),console.log(`ğŸ—ºï¸ åœ°å›¾ä¸–ç•Œä¹¦å·²ç»‘å®šåˆ°å½“å‰è§’è‰²å¡: ${i}`))}const a=e.locations.map(n=>({uid:Date.now()+Math.random(),name:n.name,content:`åœ°ç‚¹: ${n.name}\nåæ ‡: (${n.x},${n.y})\næè¿°: ${n.description}\nç±»å‹: ${n.type}${n.container?`\nå®¹å™¨: ${n.container}`:''}${n.floor?`\næ¥¼å±‚: ${n.floor}`:''}\n---`,enabled:!0,strategy:{type:'selective',keys:[n.name,`(${n.x},${n.y})`]},position:{type:'after_character_definition',order:0},probability:100,recursion:{prevent_incoming:!0,prevent_outgoing:!0,delay_until:null},extra:{x:n.x,y:n.y,description:n.description,type:n.type,container:n.container,floor:n.floor,discovered_at:n.discovered_at||Date.now(),imported_at:Date.now()}}));await updateWorldbookWith(i,()=>a,{render:'immediate'}),await r(),toastr.success(`æˆåŠŸå¯¼å…¥ ${e.locations.length} ä¸ªåœ°ç‚¹`,'ç³»ç»Ÿæç¤º',{timeOut:3e3})}catch(n){console.error('å¯¼å…¥å¤±è´¥:',n),toastr.error('å¯¼å…¥å¤±è´¥ï¼š'+n.message,'é”™è¯¯',{timeOut:5e3})}},document.body.appendChild(t),t.click(),document.body.removeChild(t)}),$('#fc-map-export').off('click').on('click',async function(n){console.log('ğŸ“¤ å¯¼å‡ºæŒ‰é’®è¢«ç‚¹å‡»'),n.preventDefault(),n.stopPropagation();try{const n=o(),t=await getWorldbook(n),e={exported_at:(new Date).toISOString(),locations:t.filter(n=>'åœ°å›¾çŸ¥è¯†æ±‡æ€»'!==n.name&&'å½“å‰ä½ç½®'!==n.name).map(n=>({name:n.name,x:n.extra?.x||0,y:n.extra?.y||0,description:n.extra?.description||'',type:n.extra?.type||'village',container:n.extra?.container,floor:n.extra?.floor,discovered_at:n.extra?.discovered_at}))},r=JSON.stringify(e,null,2),i='data:application/json;charset=utf-8,'+encodeURIComponent(r),a=`fc_map_export_${(new Date).toISOString().split('T')[0]}.json`,c=document.createElement('a');c.setAttribute('href',i),c.setAttribute('download',a),c.click(),toastr.success('åœ°å›¾æ•°æ®å·²å¯¼å‡º','ç³»ç»Ÿæç¤º',{timeOut:3e3})}catch(n){console.error('å¯¼å‡ºå¤±è´¥:',n),toastr.error('å¯¼å‡ºå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°','é”™è¯¯',{timeOut:5e3})}}),console.log('âœ… å·¥å…·æ æŒ‰é’®äº‹ä»¶ç»‘å®šå®Œæˆ'))},100),$('#fc-map-close').off('click').on('click',function(n){console.log('âŒ å…³é—­æŒ‰é’®è¢«ç‚¹å‡»'),n.preventDefault(),n.stopPropagation(),$('#fc-map-panel').hide()})}function o(){try{const n=SillyTavern?.characterId;if(n&&SillyTavern?.characters?.[n]){return`${SillyTavern.characters[n].name||'æœªçŸ¥è§’è‰²'}(æ¸¸æˆåœ°å›¾)`}return'é»˜è®¤è§’è‰²(æ¸¸æˆåœ°å›¾)'}catch(n){return console.error('è·å–è§’è‰²å¡ä¿¡æ¯å¤±è´¥:',n),'é»˜è®¤è§’è‰²(æ¸¸æˆåœ°å›¾)'}}$(()=>{async function n(n,t){console.log(`ğŸ” [${t}] å¼€å§‹æ£€æŸ¥æ¶ˆæ¯ï¼Œæ¶ˆæ¯é•¿åº¦: ${n.content?.length||0}`),console.log(`ğŸ’¬ [${t}] æ¶ˆæ¯å†…å®¹é¢„è§ˆ:`,n.content?.substring(0,100)+(n.content?.length>100?'...':''));const e=function(n){const t={locations:[]};console.log('ğŸ” å¼€å§‹è§£æXMLæ–‡æœ¬ï¼Œé•¿åº¦:',n.length),console.log('ğŸ“„ å¾…è§£ææ–‡æœ¬:',n.substring(0,200)+(n.length>200?'...':''));const o=n.match(/<fc_map>([\s\S]*?)<\/fc_map>/);if(console.log('ğŸ¯ XMLæ­£åˆ™åŒ¹é…ç»“æœ:',o?'æˆåŠŸ':'å¤±è´¥'),!o)return console.log('âŒ æœªæ‰¾åˆ° <fc_map> æ ‡ç­¾'),t;console.log('ğŸ“‹ æå–çš„XMLå†…å®¹:',o[0]);try{const n=(new DOMParser).parseFromString(o[0],'text/xml'),e=n.getElementsByTagName('parsererror');if(e.length>0)return console.error('ğŸš¨ XMLè§£æé”™è¯¯:',e[0].textContent),t;const r=n.getElementsByTagName('location');console.log('ğŸ“ æ‰¾åˆ°çš„locationå…ƒç´ æ•°é‡:',r.length);for(let n=0;n<r.length;n++){const o=r[n],e=o.getAttribute('name'),i=parseFloat(o.getAttribute('x')||'0'),a=parseFloat(o.getAttribute('y')||'0'),c=o.getAttribute('desc')||o.textContent?.trim()||'',l=o.getAttribute('type')||'city',s=o.getAttribute('container')||void 0,d=o.getAttribute('floor')?parseInt(o.getAttribute('floor')):void 0;console.log(`âœ… è§£æåˆ°åœ°ç‚¹ ${n+1}:`,{name:e,x:i,y:a,desc:c,type:l,container:s,floor:d}),e?t.locations.push({name:e,x:i,y:a,description:c,type:l,container:s,floor:d}):console.warn(`âš ï¸ åœ°ç‚¹ ${n+1} ç¼ºå°‘åç§°å±æ€§`)}const i=n.getElementsByTagName('current_location');if(i.length>0){const n=i[0],o=n.getAttribute('name'),e=parseFloat(n.getAttribute('x')||'0'),r=parseFloat(n.getAttribute('y')||'0'),a=n.getAttribute('type')||'city',c=n.getAttribute('container')||void 0,l=n.getAttribute('floor')?parseInt(n.getAttribute('floor')):void 0;o&&(t.currentLocation={name:o,x:e,y:r,type:a,container:c,floor:l},console.log('ğŸ“ è§£æåˆ°å½“å‰ä½ç½®:',t.currentLocation))}}catch(n){console.error('ğŸ’¥ XMLè§£æå¼‚å¸¸:',n)}return console.log('ğŸ‰ è§£æå®Œæˆï¼Œæœ€ç»ˆç»“æœ:',t),t}(n.content);if(e.locations.length>0||e.currentLocation){const n=o();try{await getWorldbook(n),console.log(`ğŸ“š ä¸–ç•Œä¹¦ ${n} å·²å­˜åœ¨`)}catch{await createOrReplaceWorldbook(n,[],{render:'immediate'}),console.log(`ğŸ“š åˆ›å»ºæ–°ä¸–ç•Œä¹¦: ${n}`)}const r=getCharWorldbookNames('current');r.additional.includes(n)||(await rebindCharWorldbooks('current',{primary:r.primary,additional:[...r.additional,n]}),console.log(`ğŸ—ºï¸ åœ°å›¾ä¸–ç•Œä¹¦å·²ç»‘å®šåˆ°å½“å‰è§’è‰²å¡: ${n}`)),await updateWorldbookWith(n,n=>{for(const o of e.locations){const e=n.findIndex(n=>n.name===o.name);if(e>=0){const r=n[e];r.content=`åœ°ç‚¹: ${o.name}\nåæ ‡: (${r.extra.x}, ${r.extra.y})\næè¿°: ${o.description}\nç±»å‹: ${o.type}${o.container?`\nå®¹å™¨: ${o.container}`:''}${o.floor?`\næ¥¼å±‚: ${o.floor}`:''}\n---`,r.extra={...r.extra,description:o.description,type:o.type,container:o.container,floor:o.floor,updated_at:Date.now(),source:t}}else n.push({uid:Date.now()+Math.random(),name:o.name,content:`åœ°ç‚¹: ${o.name}\nåæ ‡: (${o.x}, ${o.y})\næè¿°: ${o.description}\nç±»å‹: ${o.type}${o.container?`\nå®¹å™¨: ${o.container}`:''}${o.floor?`\næ¥¼å±‚: ${o.floor}`:''}\n---`,enabled:!0,strategy:{type:'selective',keys:[o.name,`(${o.x},${o.y})`]},position:{type:'after_character_definition',order:0},probability:100,recursion:{prevent_incoming:!0,prevent_outgoing:!0,delay_until:null},extra:{x:o.x,y:o.y,description:o.description,type:o.type,container:o.container,floor:o.floor,discovered_at:Date.now(),source:t}})}if(e.currentLocation){const o=n.findIndex(n=>'å½“å‰ä½ç½®'===n.name),r={uid:Date.now()+Math.random(),name:'å½“å‰ä½ç½®',content:`å½“å‰ä½ç½®: ${e.currentLocation.name}(${e.currentLocation.x}, ${e.currentLocation.y})\nç±»å‹: ${e.currentLocation.type}${e.currentLocation.container?`\nå®¹å™¨: ${e.currentLocation.container}`:''}${e.currentLocation.floor?`\næ¥¼å±‚: ${e.currentLocation.floor}`:''}`,enabled:!0,strategy:{type:'constant'},position:{type:'before_character_definition',order:0},probability:100,recursion:{prevent_incoming:!0,prevent_outgoing:!0,delay_until:null},extra:{is_current_location:!0,...e.currentLocation,updated_at:Date.now(),source:t}};o>=0?n[o]=r:n.push(r)}return n},{render:'immediate'}),console.log('ğŸ“š ç«‹å³æ›´æ–°AIçŸ¥è¯†æ±‡æ€»...'),await async function(){try{const n=o(),t=(await getWorldbook(n)).filter(n=>'åœ°å›¾çŸ¥è¯†æ±‡æ€»'!==n.name&&'å½“å‰ä½ç½®'!==n.name);if(console.log(`ğŸ“š æ±‡æ€» ${t.length} ä¸ªåœ°ç‚¹æ¡ç›®`),t.length>0){const o=`å·²çŸ¥åœ°ç‚¹åˆ—è¡¨ï¼š\n| åœ°ç‚¹åç§° | åæ ‡ | ç±»å‹ | å®¹å™¨ | æ¥¼å±‚ |\n|----------|------|------|--------|------|\n${t.map(n=>`| ${n.name} | (${n.extra?.x||0},${n.extra?.y||0}) | ${n.extra?.type||'outdoor'} | ${n.extra?.container||'-'} | ${n.extra?.floor||'-'} |`).join('\n')}`;console.log('ğŸ“ æ±‡æ€»å†…å®¹:',o),await updateWorldbookWith(n,n=>{const t=n.find(n=>'åœ°å›¾çŸ¥è¯†æ±‡æ€»'===n.name);return t?(console.log('ğŸ“ æ›´æ–°ç°æœ‰æ±‡æ€»æ¡ç›®'),t.content=o):(console.log('ğŸ“ åˆ›å»ºæ–°çš„æ±‡æ€»æ¡ç›®'),n.push({uid:Date.now()+Math.random(),name:'åœ°å›¾çŸ¥è¯†æ±‡æ€»',content:o,enabled:!0,strategy:{type:'constant'},position:{type:'before_character_definition',order:0},probability:100})),n},{render:'immediate'}),console.log('âœ… åœ°å›¾çŸ¥è¯†æ±‡æ€»æ¡ç›®å·²æ›´æ–°')}else console.log('âš ï¸ æ²¡æœ‰åœ°ç‚¹æ¡ç›®ï¼Œè·³è¿‡æ±‡æ€»æ›´æ–°')}catch(n){console.error('ğŸ’¥ æ›´æ–°åœ°å›¾çŸ¥è¯†æ±‡æ€»å¤±è´¥:',n)}}();const i=e.locations.length,a=e.currentLocation?1:0;toastr.success(`ğŸ“ [${t}] æ›´æ–°åœ°å›¾æ•°æ®: ${i} ä¸ªåœ°ç‚¹${a?' + å½“å‰ä½ç½®':''}`)}}console.log('ğŸš€ FCåœ°å›¾ç³»ç»Ÿå·²åŠ è½½'),toastr.success('FCåœ°å›¾ç³»ç»Ÿå·²åŠ è½½','ç³»ç»Ÿæç¤º',{timeOut:3e3,positionClass:'toast-top-right'}),t(),console.log('âœ… åœ°å›¾ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œç›‘å¬äº‹ä»¶å·²è®¾ç½®'),eventOn(tavern_events.MESSAGE_RECEIVED,async t=>{console.log('ğŸ“¨ æ”¶åˆ°æ–°æ¶ˆæ¯ï¼ŒID:',t);try{const o=getChatMessages(t)[0];o&&o.message?(console.log('ğŸ“¨ è·å–åˆ°æ–°æ¶ˆæ¯å†…å®¹ï¼Œå‡†å¤‡è§£æ...'),await n({content:o.message,id:t,is_user:'user'===o.role},'AIå›å¤')):console.log('âŒ æ— æ³•æ‰¾åˆ°æ–°æ¶ˆæ¯å†…å®¹')}catch(n){console.error('ğŸ’¥ è·å–æ–°æ¶ˆæ¯å¤±è´¥:',n)}}),eventOn(tavern_events.MESSAGE_EDITED,async t=>{console.log('âœï¸ æ¶ˆæ¯è¢«ç¼–è¾‘ï¼ŒID:',t);try{const o=getChatMessages(t)[0];o&&o.message?(console.log('ğŸ“ è·å–åˆ°ç¼–è¾‘åçš„æ¶ˆæ¯å†…å®¹ï¼Œå‡†å¤‡è§£æ...'),await n({content:o.message,id:t,is_user:'user'===o.role},'æ¶ˆæ¯ç¼–è¾‘')):console.log('âŒ æ— æ³•æ‰¾åˆ°ç¼–è¾‘åçš„æ¶ˆæ¯å†…å®¹')}catch(n){console.error('ğŸ’¥ è·å–ç¼–è¾‘æ¶ˆæ¯å¤±è´¥:',n)}})});