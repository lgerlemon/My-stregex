var e;!function(e){e.LOOP='loop',e.SINGLE='single',e.SHUFFLE='shuffle'}(e||(e={}));let t=null,n=[],o=-1,a=!1,r='gufeng',s=e.LOOP,i='éŸ³ä¹',l=[],c=!0,u=.7;const g='fc_music_player_state';let f=0;function m(){if(!t){t=new Audio;const r=localStorage.getItem('fate_console_ui_state');if(r)try{const e=JSON.parse(r);c=!1!==e.musicSoundEnabled}catch(e){console.warn('è§£æUIçŠ¶æ€å¤±è´¥:',e),c=!0}t.volume=c?.7:0,t.addEventListener('ended',()=>{!function(){switch(s){case e.SINGLE:o>=0&&E(o);break;case e.SHUFFLE:if(n.length>1){let e;do{e=Math.floor(Math.random()*n.length)}while(e===o&&n.length>1);E(e)}else b();break;case e.LOOP:default:b()}}()}),t.addEventListener('play',()=>{a=!0,f=Date.now(),h()}),t.addEventListener('pause',()=>{a=!1,h()}),t.addEventListener('loadedmetadata',()=>{t&&h()});let i=0;t.addEventListener('timeupdate',()=>{if(t){const e=Date.now();e-i>=1e3&&(h(),i=e)}})}}function h(){if(!t)return;const e={isPlaying:a,currentTime:t.currentTime||0,duration:t.duration||180,playMode:s,currentMusicEntry:i,availableMusicEntries:l,timestamp:Date.now()};try{localStorage.setItem(g,JSON.stringify(e))}catch(e){console.warn('ä¿å­˜æ’­æ”¾çŠ¶æ€å¤±è´¥:',e)}}function d(){try{const e=localStorage.getItem('fate_console_ui_state');if(e){return JSON.parse(e).theme||'gufeng'}}catch(e){console.warn('è¯»å–ä¸»é¢˜å¤±è´¥:',e)}return'gufeng'}async function v(e){try{e&&(i=e),r=d(),console.log('å½“å‰ä¸»é¢˜:',r,'ä½¿ç”¨æ¡ç›®:',i);const t=await getWorldbook('å‘½è¿ç»ˆç«¯');if(!t)return void toastr.error('æœªæ‰¾åˆ°"å‘½è¿ç»ˆç«¯"ä¸–ç•Œä¹¦','å‘½è¿æ­Œæ¨¡å—');const o=t.filter(e=>e.name.includes('éŸ³ä¹')||e.name.includes('å°æ›²')||e.name.includes('bgm'));l=o.map(e=>e.name);let a=t.find(e=>e.name===i&&e.enabled);if(!a&&o.length>0&&(a=o[0],i=a.name,console.log(`å›é€€åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨æ¡ç›®: ${i}`)),!a||!a.content)return void toastr.error('ä¸–ç•Œä¹¦ä¸­æœªæ‰¾åˆ°å¯ç”¨çš„éŸ³ä¹æ¡ç›®','å‘½è¿æ­Œæ¨¡å—');const s=a.content.split('\n').map(e=>e.trim()).filter(e=>e);n=[];const c={å¤é£:'gufeng',ä»™ä¾ :'xianxia',æ°‘ä¿—:'minsu',æ­¦ä¾ :'wuxia',ç„å¹»:'xuanhuan',æ—¥å¼:'nihon',jrpg:'jrpg'},u=s.some(e=>e.endsWith('ï¼š')&&Object.prototype.hasOwnProperty.call(c,e.slice(0,-1)));let g='';for(const e of s)if(e.endsWith('ï¼š')){const t=e.slice(0,-1);g=c[t]||t}else if(e){if(!u||g===r)try{let t,o;if(e.includes('|')){const a=e.split('|').map(e=>e.trim());if(a.length>=2)t=a[0],o=a[a.length-1];else{o=e;const a=o.match(/([^/]+\.(?:mp3|wav|ogg))$/i);t=a?a[1].replace(/\.(mp3|wav|ogg)$/i,''):`éŸ³ä¹ ${n.length+1}`}}else{o=e;const a=o.match(/([^/]+\.(?:mp3|wav|ogg))$/i);t=a?a[1].replace(/\.(mp3|wav|ogg)$/i,''):`éŸ³ä¹ ${n.length+1}`}n.push({title:t,url:o})}catch(t){console.warn(`è§£æéŸ³ä¹é“¾æ¥å¤±è´¥: ${e}`,t)}}n.length>0?(toastr.success(`å·²åŠ è½½ ${n.length} é¦–éŸ³ä¹ (${r}) [${i}]`,'å‘½è¿æ­Œæ¨¡å—'),B()):toastr.warning(`å½“å‰ä¸»é¢˜ (${r}) æ²¡æœ‰éŸ³ä¹ [${i}]`,'éŸ³ä¹æ’­æ”¾å™¨')}catch(e){console.error('åŠ è½½éŸ³ä¹å¤±è´¥:',e),toastr.error('åŠ è½½éŸ³ä¹å¤±è´¥','å‘½è¿æ­Œæ¨¡å—')}}function E(e){if(e<0||e>=n.length)return;o=e;const a=n[e];console.log('å°è¯•æ’­æ”¾éŸ³ä¹:',a),t&&(t.removeEventListener('error',p),t.removeEventListener('canplaythrough',w),t.addEventListener('error',p,{once:!0}),t.addEventListener('canplaythrough',w,{once:!0}),t.src=a.url,console.log('è®¾ç½®éŸ³é¢‘æº:',a.url),t.load()),function(e){const t={currentTrack:e,currentTrackIndex:o,isPlaying:!1,currentTheme:r,timestamp:Date.now()};try{localStorage.setItem(g,JSON.stringify(t))}catch(e){console.warn('ä¿å­˜æ’­æ”¾çŠ¶æ€å¤±è´¥:',e)}}(a),toastr.info(`æ­£åœ¨åŠ è½½: ${a.title}`,'å‘½è¿æ­Œæ¨¡å—')}function p(e){const t=e.target.error;console.error('éŸ³é¢‘åŠ è½½å¤±è´¥:',t);let n='æœªçŸ¥é”™è¯¯';if(t)switch(t.code){case MediaError.MEDIA_ERR_ABORTED:n='æ’­æ”¾è¢«ä¸­æ­¢';break;case MediaError.MEDIA_ERR_NETWORK:n='ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½éŸ³é¢‘';break;case MediaError.MEDIA_ERR_DECODE:n='éŸ³é¢‘è§£ç å¤±è´¥';break;case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:n='ä¸æ”¯æŒçš„éŸ³é¢‘æ ¼å¼æˆ–é“¾æ¥æ— æ•ˆ'}toastr.error(`éŸ³é¢‘åŠ è½½å¤±è´¥: ${n}`,'å‘½è¿æ­Œæ¨¡å—'),setTimeout(()=>{b()},2e3)}function w(){console.log('éŸ³é¢‘åŠ è½½å®Œæˆï¼Œå¼€å§‹æ’­æ”¾'),t&&(t.volume=c?u:0,t.play().catch(e=>{console.error('æ’­æ”¾å¤±è´¥:',e),toastr.error(`æ’­æ”¾å¤±è´¥: ${e.message}`,'å‘½è¿æ­Œæ¨¡å—')}))}function O(){t&&0!==n.length?a?(t.pause(),toastr.info('å·²æš‚åœ','å‘½è¿æ­Œæ¨¡å—')):-1===o?E(0):t.play().catch(e=>{console.error('æ’­æ”¾å¤±è´¥:',e),toastr.error('æ’­æ”¾å¤±è´¥','éŸ³ä¹æ’­æ”¾å™¨')}):toastr.warning('æ²¡æœ‰å¯æ’­æ”¾çš„éŸ³ä¹','å‘½è¿æ­Œæ¨¡å—')}function b(){if(0===n.length)return;E((o+1)%n.length)}function y(){if(0===n.length)return;E(o<=0?n.length-1:o-1)}function S(){switch(s){case e.LOOP:s=e.SINGLE,toastr.info('å·²åˆ‡æ¢åˆ°å•æ›²å¾ªç¯','å‘½è¿æ­Œæ¨¡å—');break;case e.SINGLE:s=e.SHUFFLE,toastr.info('å·²åˆ‡æ¢åˆ°éšæœºæ’­æ”¾','å‘½è¿æ­Œæ¨¡å—');break;case e.SHUFFLE:s=e.LOOP,toastr.info('å·²åˆ‡æ¢åˆ°åˆ—è¡¨å¾ªç¯','å‘½è¿æ­Œæ¨¡å—')}h()}function L(){t&&(c?(u=t.volume,t.volume=0,c=!1,toastr.info('å·²é™éŸ³','å‘½è¿æ­Œæ¨¡å—')):(t.volume=u,c=!0,toastr.info('å·²å–æ¶ˆé™éŸ³','å‘½è¿æ­Œæ¨¡å—')))}function I(e){l.includes(e)&&e!==i?(console.log(`åˆ‡æ¢éŸ³ä¹æ¡ç›®: ${i} -> ${e}`),v(e)):toastr.warning(`éŸ³ä¹æ¡ç›®"${e}"ä¸å­˜åœ¨æˆ–å·²æ˜¯å½“å‰æ¡ç›®`,'å‘½è¿æ­Œæ¨¡å—')}function k(){if(0===l.length)return void toastr.info('æ²¡æœ‰æ‰¾åˆ°éŸ³ä¹æ¡ç›®','å‘½è¿æ­Œæ¨¡å—');let e='ğŸ¼ å¯ç”¨éŸ³ä¹æ¡ç›®:\n\n';l.forEach((t,n)=>{e+=`${t===i?'â–¶ï¸':'  '} ${n+1}. ${t}\n`}),console.log(e),toastr.info('æŸ¥çœ‹æ§åˆ¶å°æŸ¥çœ‹å®Œæ•´æ¡ç›®åˆ—è¡¨','å‘½è¿æ­Œæ¨¡å—')}function N(){if(0===n.length)return void toastr.info('æ’­æ”¾åˆ—è¡¨ä¸ºç©º','å‘½è¿æ­Œæ¨¡å—');let e='ğŸµ æ’­æ”¾åˆ—è¡¨:\n\n';n.forEach((t,n)=>{e+=`${n===o?'â–¶ï¸':'  '} ${n+1}. ${t.title}\n`}),console.log(e),toastr.info('æŸ¥çœ‹æ§åˆ¶å°æŸ¥çœ‹å®Œæ•´æ’­æ”¾åˆ—è¡¨','å‘½è¿æ­Œæ¨¡å—')}function B(){const t=s===e.LOOP?'ğŸ”':s===e.SINGLE?'ğŸ”‚':'ğŸ”€',o=s===e.LOOP?'åˆ—è¡¨å¾ªç¯':s===e.SINGLE?'å•æ›²å¾ªç¯':'éšæœºæ’­æ”¾',a=c?'ğŸ”Š':'ğŸ”‡',r=c?'é™éŸ³':'å–æ¶ˆé™éŸ³',u=[{name:'ğŸµ åŠ è½½éŸ³ä¹',visible:0===n.length},{name:'â–¶ï¸ æ’­æ”¾/æš‚åœ',visible:n.length>0},{name:'â®ï¸ ä¸Šä¸€é¦–',visible:n.length>0},{name:'â­ï¸ ä¸‹ä¸€é¦–',visible:n.length>0},{name:`${t} ${o}`,visible:n.length>0},{name:`${a} ${r}`,visible:n.length>0},{name:'ğŸ“‹ æ˜¾ç¤ºåˆ—è¡¨',visible:n.length>0},{name:'ğŸ¼ åˆ‡æ¢æ¡ç›®',visible:l.length>1},{name:'ğŸ“‹ æ˜¾ç¤ºæ¡ç›®',visible:l.length>0}];if(replaceScriptButtons(u),n.length>0&&eventOn(getButtonEvent(`${t} ${o}`),()=>{S(),setTimeout(()=>B(),100)}),l.length>1&&eventOn(getButtonEvent('ğŸ¼ åˆ‡æ¢æ¡ç›®'),()=>{!function(){if(l.length<=1)return void toastr.info('åªæœ‰ä¸€ä¸ªéŸ³ä¹æ¡ç›®ï¼Œæ— éœ€åˆ‡æ¢','å‘½è¿æ­Œæ¨¡å—');const e=l.map(e=>({name:`${e===i?'â–¶ï¸':'ğŸµ'} ${e}`,visible:!0}));replaceScriptButtons(e),l.forEach(e=>{eventOn(getButtonEvent(`${e===i?'â–¶ï¸':'ğŸµ'} ${e}`),()=>{I(e),setTimeout(()=>B(),500)})}),toastr.info('ç‚¹å‡»æ¡ç›®åç§°åˆ‡æ¢éŸ³ä¹æ¥æº','å‘½è¿æ­Œæ¨¡å—')}()}),l.length>0&&eventOn(getButtonEvent('ğŸ“‹ æ˜¾ç¤ºæ¡ç›®'),k),n.length>0){eventOn(getButtonEvent(`${c?'ğŸ”Š':'ğŸ”‡'} ${c?'é™éŸ³':'å–æ¶ˆé™éŸ³'}`),()=>{L(),setTimeout(()=>B(),100)})}}function M(){window.addEventListener('storage',e=>{if('fc_music_command'===e.key&&e.newValue)try{!function(e){switch(console.log('æ”¶åˆ°å‘½ä»¤:',e),e){case'toggle':O();break;case'next':b();break;case'previous':y();break;case'toggle_mode':S(),B();break;case'load_music':v();break;default:if(e.startsWith('play_')){const t=parseInt(e.substring(5));!isNaN(t)&&t>=0&&t<n.length&&E(t)}else if(e.startsWith('switch_entry_')){I(e.substring(13))}else if(e.startsWith('load_music_')){v(e.substring(11))}else'mute'===e?c&&L():'unmute'===e&&(c||L())}}(JSON.parse(e.newValue).command)}catch(e){console.warn('è§£æå‘½ä»¤å¤±è´¥:',e)}})}$(()=>{m(),B(),window.addEventListener('storage',e=>{if('fate_console_ui_state'===e.key&&e.newValue)try{const n=JSON.parse(e.newValue),o=n.theme,a=n.musicSoundEnabled;o!==r&&(console.log('æ£€æµ‹åˆ°ä¸»é¢˜å˜åŒ–:',r,'->',o),r=o,v()),a!==c&&(console.log('æ£€æµ‹åˆ°å£°éŸ³å¼€å…³å˜åŒ–:',c,'->',a),c=a,t&&(t.volume=c?u:0))}catch(e){console.warn('è§£æUIçŠ¶æ€å˜åŒ–å¤±è´¥:',e)}}),setInterval(()=>{const e=d();e!==r&&(console.log('æ£€æµ‹åˆ°ä¸»é¢˜å˜åŒ–ï¼ˆè½®è¯¢ï¼‰:',r,'->',e),r=e,v());const n=localStorage.getItem('fate_console_ui_state');if(n)try{const e=!1!==JSON.parse(n).musicSoundEnabled;e!==c&&(console.log('æ£€æµ‹åˆ°å£°éŸ³å¼€å…³å˜åŒ–ï¼ˆè½®è¯¢ï¼‰:',c,'->',e),c=e,t&&(t.volume=c?u:0))}catch(e){console.warn('è§£æUIçŠ¶æ€å¤±è´¥ï¼ˆè½®è¯¢ï¼‰:',e)}},1e3),M(),eventOn(getButtonEvent('ğŸµ åŠ è½½éŸ³ä¹'),async()=>{await v()}),eventOn(getButtonEvent('â–¶ï¸ æ’­æ”¾/æš‚åœ'),O),eventOn(getButtonEvent('â®ï¸ ä¸Šä¸€é¦–'),y),eventOn(getButtonEvent('â­ï¸ ä¸‹ä¸€é¦–'),b),eventOn(getButtonEvent('ğŸ“‹ æ˜¾ç¤ºåˆ—è¡¨'),N),toastr.success('å‘½è¿æ­Œæ¨¡å—å·²å°±ç»ª','å‘½è¿ç»ˆç«¯')}),$(window).on('pagehide',()=>{t&&(t.pause(),t=null),toastr.info('å‘½è¿æ­Œæ¨¡å—å·²å¸è½½','å‘½è¿ç»ˆç«¯')});