var e;!function(e){e.LOOP='loop',e.SINGLE='single',e.SHUFFLE='shuffle'}(e||(e={}));let t=null,n=[],o=-1,r=!1,a='gufeng',s=e.LOOP,i='éŸ³ä¹',c=[];let l=0;function u(){if(!t){t=new Audio,t.volume=.7,t.addEventListener('ended',()=>{!function(){switch(s){case e.SINGLE:o>=0&&v(o);break;case e.SHUFFLE:if(n.length>1){let e;do{e=Math.floor(Math.random()*n.length)}while(e===o&&n.length>1);v(e)}else p();break;case e.LOOP:default:p()}}()}),t.addEventListener('play',()=>{r=!0,l=Date.now(),g()}),t.addEventListener('pause',()=>{r=!1,g()}),t.addEventListener('loadedmetadata',()=>{t&&g()});let a=0;t.addEventListener('timeupdate',()=>{if(t){const e=Date.now();e-a>=1e3&&(g(),a=e)}})}}function g(){if(!t)return;const e={currentTrack:o>=0&&o<n.length?n[o]:null,currentTrackIndex:o,isPlaying:r,currentTime:t.currentTime||0,duration:t.duration||180,playMode:s,timestamp:Date.now()};try{eventEmit('fc_music_state',e)}catch(e){console.warn('å‘é€æ’­æ”¾çŠ¶æ€å¤±è´¥:',e)}}function f(){try{const e=localStorage.getItem('fate_console_ui_state');if(e){return JSON.parse(e).theme||'gufeng'}}catch(e){console.warn('è¯»å–ä¸»é¢˜å¤±è´¥:',e)}return'gufeng'}async function m(e){try{e&&(i=e),a=f(),console.log('å½“å‰ä¸»é¢˜:',a,'ä½¿ç”¨æ¡ç›®:',i);const t=await getWorldbook('å‘½è¿ç»ˆç«¯');if(!t)return void toastr.error('æœªæ‰¾åˆ°"å‘½è¿ç»ˆç«¯"ä¸–ç•Œä¹¦','å‘½è¿æ­Œæ¨¡å—');const o=t.filter(e=>e.name.includes('éŸ³ä¹')||e.name.includes('å°æ›²')||e.name.includes('bgm'));c=o.map(e=>e.name);let r=t.find(e=>e.name===i&&e.enabled);if(!r&&o.length>0&&(r=o[0],i=r.name,console.log(`å›é€€åˆ°ç¬¬ä¸€ä¸ªå¯ç”¨æ¡ç›®: ${i}`)),!r||!r.content)return void toastr.error('ä¸–ç•Œä¹¦ä¸­æœªæ‰¾åˆ°å¯ç”¨çš„éŸ³ä¹æ¡ç›®','å‘½è¿æ­Œæ¨¡å—');const s=r.content.split('\n').map(e=>e.trim()).filter(e=>e);n=[];const l={å¤é£:'gufeng',ä»™ä¾ :'xianxia',æ°‘ä¿—:'minsu',æ­¦ä¾ :'wuxia',ç„å¹»:'xuanhuan',æ—¥å¼:'nihon',jrpg:'jrpg'},u=s.some(e=>e.endsWith('ï¼š')&&Object.prototype.hasOwnProperty.call(l,e.slice(0,-1)));let g='';for(const e of s)if(e.endsWith('ï¼š')){const t=e.slice(0,-1);g=l[t]||t}else if(e){if(!u||g===a)try{let t,o;if(e.includes('|')){const r=e.split('|').map(e=>e.trim());if(r.length>=2)t=r[0],o=r[r.length-1];else{o=e;const r=o.match(/([^/]+\.(?:mp3|wav|ogg))$/i);t=r?r[1].replace(/\.(mp3|wav|ogg)$/i,''):`éŸ³ä¹ ${n.length+1}`}}else{o=e;const r=o.match(/([^/]+\.(?:mp3|wav|ogg))$/i);t=r?r[1].replace(/\.(mp3|wav|ogg)$/i,''):`éŸ³ä¹ ${n.length+1}`}n.push({title:t,url:o})}catch(t){console.warn(`è§£æéŸ³ä¹é“¾æ¥å¤±è´¥: ${e}`,t)}}if(n.length>0){toastr.success(`å·²åŠ è½½ ${n.length} é¦–éŸ³ä¹ (${a}) [${i}]`,'å‘½è¿æ­Œæ¨¡å—'),L();const e={currentEntry:i,availableEntries:c,playlist:n,timestamp:Date.now()};eventEmit('fc_music_entry_update',e)}else toastr.warning(`å½“å‰ä¸»é¢˜ (${a}) æ²¡æœ‰éŸ³ä¹ [${i}]`,'éŸ³ä¹æ’­æ”¾å™¨')}catch(e){console.error('åŠ è½½éŸ³ä¹å¤±è´¥:',e),toastr.error('åŠ è½½éŸ³ä¹å¤±è´¥','å‘½è¿æ­Œæ¨¡å—')}}function v(e){if(e<0||e>=n.length)return;o=e;const r=n[e];console.log('å°è¯•æ’­æ”¾éŸ³ä¹:',r),t&&(t.removeEventListener('error',E),t.removeEventListener('canplaythrough',h),t.addEventListener('error',E,{once:!0}),t.addEventListener('canplaythrough',h,{once:!0}),t.src=r.url,console.log('è®¾ç½®éŸ³é¢‘æº:',r.url),t.load()),function(e){const t={currentTrack:e,currentTrackIndex:o,isPlaying:!1,currentTime:0,duration:180,playMode:s,timestamp:Date.now()};try{eventEmit('fc_music_state',t)}catch(e){console.warn('å‘é€æ’­æ”¾çŠ¶æ€å¤±è´¥:',e)}}(r),toastr.info(`æ­£åœ¨åŠ è½½: ${r.title}`,'å‘½è¿æ­Œæ¨¡å—')}function E(e){const t=e.target.error;console.error('éŸ³é¢‘åŠ è½½å¤±è´¥:',t);let n='æœªçŸ¥é”™è¯¯';if(t)switch(t.code){case MediaError.MEDIA_ERR_ABORTED:n='æ’­æ”¾è¢«ä¸­æ­¢';break;case MediaError.MEDIA_ERR_NETWORK:n='ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½éŸ³é¢‘';break;case MediaError.MEDIA_ERR_DECODE:n='éŸ³é¢‘è§£ç å¤±è´¥';break;case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:n='ä¸æ”¯æŒçš„éŸ³é¢‘æ ¼å¼æˆ–é“¾æ¥æ— æ•ˆ'}toastr.error(`éŸ³é¢‘åŠ è½½å¤±è´¥: ${n}`,'å‘½è¿æ­Œæ¨¡å—'),setTimeout(()=>{p()},2e3)}function h(){console.log('éŸ³é¢‘åŠ è½½å®Œæˆï¼Œå¼€å§‹æ’­æ”¾'),t&&t.play().catch(e=>{console.error('æ’­æ”¾å¤±è´¥:',e),toastr.error(`æ’­æ”¾å¤±è´¥: ${e.message}`,'å‘½è¿æ­Œæ¨¡å—')})}function d(){t&&0!==n.length?r?(t.pause(),toastr.info('å·²æš‚åœ','å‘½è¿æ­Œæ¨¡å—')):-1===o?v(0):t.play().catch(e=>{console.error('æ’­æ”¾å¤±è´¥:',e),toastr.error('æ’­æ”¾å¤±è´¥','éŸ³ä¹æ’­æ”¾å™¨')}):toastr.warning('æ²¡æœ‰å¯æ’­æ”¾çš„éŸ³ä¹','å‘½è¿æ­Œæ¨¡å—')}function p(){if(0===n.length)return;v((o+1)%n.length)}function w(){if(0===n.length)return;v(o<=0?n.length-1:o-1)}function O(){switch(s){case e.LOOP:s=e.SINGLE,toastr.info('å·²åˆ‡æ¢åˆ°å•æ›²å¾ªç¯','å‘½è¿æ­Œæ¨¡å—');break;case e.SINGLE:s=e.SHUFFLE,toastr.info('å·²åˆ‡æ¢åˆ°éšæœºæ’­æ”¾','å‘½è¿æ­Œæ¨¡å—');break;case e.SHUFFLE:s=e.LOOP,toastr.info('å·²åˆ‡æ¢åˆ°åˆ—è¡¨å¾ªç¯','å‘½è¿æ­Œæ¨¡å—')}g()}function b(e){if(c.includes(e)&&e!==i){console.log(`åˆ‡æ¢éŸ³ä¹æ¡ç›®: ${i} -> ${e}`);const t={currentEntry:e,availableEntries:c,timestamp:Date.now()};eventEmit('fc_music_entry_update',t),m(e)}else toastr.warning(`éŸ³ä¹æ¡ç›®"${e}"ä¸å­˜åœ¨æˆ–å·²æ˜¯å½“å‰æ¡ç›®`,'å‘½è¿æ­Œæ¨¡å—')}function y(){if(0===n.length)return void toastr.info('æ’­æ”¾åˆ—è¡¨ä¸ºç©º','å‘½è¿æ­Œæ¨¡å—');let e='ğŸµ æ’­æ”¾åˆ—è¡¨:\n\n';n.forEach((t,n)=>{e+=`${n===o?'â–¶ï¸':'  '} ${n+1}. ${t.title}\n`}),console.log(e),toastr.info('æŸ¥çœ‹æ§åˆ¶å°æŸ¥çœ‹å®Œæ•´æ’­æ”¾åˆ—è¡¨','å‘½è¿æ­Œæ¨¡å—')}function L(){const t=s===e.LOOP?'ğŸ”':s===e.SINGLE?'ğŸ”‚':'ğŸ”€',o=s===e.LOOP?'åˆ—è¡¨å¾ªç¯':s===e.SINGLE?'å•æ›²å¾ªç¯':'éšæœºæ’­æ”¾',r=[{name:'ğŸµ åŠ è½½éŸ³ä¹',visible:0===n.length},{name:'â–¶ï¸ æ’­æ”¾/æš‚åœ',visible:n.length>0},{name:'â®ï¸ ä¸Šä¸€é¦–',visible:n.length>0},{name:'â­ï¸ ä¸‹ä¸€é¦–',visible:n.length>0},{name:`${t} ${o}`,visible:n.length>0},{name:'ğŸ“‹ æ˜¾ç¤ºåˆ—è¡¨',visible:n.length>0},{name:'ğŸ¼ åˆ‡æ¢æ¡ç›®',visible:c.length>1}];replaceScriptButtons(r),eventClearEvent(getButtonEvent(`${t} ${o}`)),eventClearEvent(getButtonEvent('ğŸ¼ åˆ‡æ¢æ¡ç›®')),n.length>0&&eventOn(getButtonEvent(`${t} ${o}`),()=>{O(),setTimeout(()=>L(),100)}),c.length>1&&eventOn(getButtonEvent('ğŸ¼ åˆ‡æ¢æ¡ç›®'),()=>{!function(){if(c.length<=1)return void toastr.info('åªæœ‰ä¸€ä¸ªéŸ³ä¹æ¡ç›®ï¼Œæ— éœ€åˆ‡æ¢','å‘½è¿æ­Œæ¨¡å—');c.forEach(e=>{eventClearEvent(getButtonEvent(`â–¶ï¸ ${e}`)),eventClearEvent(getButtonEvent(`ğŸµ ${e}`))}),eventClearEvent(getButtonEvent('â¬…ï¸ è¿”å›'));const e=[...c.map(e=>({name:`${e===i?'â–¶ï¸':'ğŸµ'} ${e}`,visible:!0})),{name:'â¬…ï¸ è¿”å›',visible:!0}];replaceScriptButtons(e),c.forEach(e=>{eventOn(getButtonEvent(`${e===i?'â–¶ï¸':'ğŸµ'} ${e}`),()=>{b(e),setTimeout(()=>L(),500)})}),eventOn(getButtonEvent('â¬…ï¸ è¿”å›'),()=>{L()}),toastr.info('ç‚¹å‡»æ¡ç›®åç§°åˆ‡æ¢éŸ³ä¹æ¥æºï¼Œç‚¹å‡»è¿”å›å›åˆ°ä¸»èœå•','å‘½è¿æ­Œæ¨¡å—')}()})}function k(){eventOn('fc_music_command',e=>{try{!function(e){switch(console.log('æ”¶åˆ°å‘½ä»¤:',e),e){case'toggle':d();break;case'next':p();break;case'previous':w();break;case'toggle_mode':O(),L();break;case'load_music':m();break;default:if(e.startsWith('play_')){const t=parseInt(e.substring(5));!isNaN(t)&&t>=0&&t<n.length&&v(t)}else if(e.startsWith('switch_entry_')){b(e.substring(13))}else if(e.startsWith('load_music_')){m(e.substring(11))}}}(e.command)}catch(e){console.warn('å¤„ç†å‘½ä»¤å¤±è´¥:',e)}})}$(()=>{u(),L(),setInterval(()=>{const e=f();e!==a&&(console.log('æ£€æµ‹åˆ°ä¸»é¢˜å˜åŒ–:',a,'->',e),t&&r&&(t.pause(),r=!1,o=-1,g()),a=e,m())},1e3),k(),eventOn(getButtonEvent('ğŸ“‹ æ˜¾ç¤ºåˆ—è¡¨'),y),eventOn(getButtonEvent('ğŸµ åŠ è½½éŸ³ä¹'),async()=>{await m()}),eventOn(getButtonEvent('â–¶ï¸ æ’­æ”¾/æš‚åœ'),d),eventOn(getButtonEvent('â®ï¸ ä¸Šä¸€é¦–'),w),eventOn(getButtonEvent('â­ï¸ ä¸‹ä¸€é¦–'),p),setTimeout(()=>{const e={currentEntry:i,availableEntries:c,timestamp:Date.now()};eventEmit('fc_music_entry_update',e)},100),toastr.success('å‘½è¿æ­Œæ¨¡å—å·²å°±ç»ª','å‘½è¿ç»ˆç«¯')}),$(window).on('pagehide',()=>{t&&(t.pause(),t=null),toastr.info('å‘½è¿æ­Œæ¨¡å—å·²å¸è½½','å‘½è¿ç»ˆç«¯')});